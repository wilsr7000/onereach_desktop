<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Export Preview</title>

    <!-- Google Fonts for Journey Map style -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400;1,600&family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Smart Export Styles -->
    <link rel="stylesheet" href="smart-export-styles.css" />

    <!-- Mermaid.js for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
      mermaid.initialize({
        startOnLoad: false, // We'll initialize manually after iframe loads
        theme: 'base',
        themeVariables: {
          primaryColor: '#3B82F6',
          primaryTextColor: '#2C2C2C',
          primaryBorderColor: '#3B82F6',
          lineColor: '#6B7280',
          secondaryColor: '#F5F2ED',
          tertiaryColor: '#10B981',
          background: '#FFFFFF',
          mainBkg: '#FFFFFF',
          secondBkg: '#F5F2ED',
          tertiaryBkg: '#F3F4F6',
          textColor: '#2C2C2C',
          border1: '#E5E7EB',
          border2: '#D1D5DB',
          fontFamily: 'Inter, sans-serif',
        },
      });
    </script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #1e1e1e;
        color: #e0e0e0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .toolbar {
        background-color: #2d2d2d;
        padding: 15px;
        border-bottom: 1px solid #3e3e3e;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .toolbar-title {
        font-size: 16px;
        font-weight: 500;
      }

      .toolbar-actions {
        display: flex;
        gap: 10px;
      }

      button {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background-color: #0e639c;
        color: white;
      }

      .btn-primary:hover {
        background-color: #1177bb;
      }

      .btn-secondary {
        background-color: #3e3e3e;
        color: #e0e0e0;
      }

      .btn-secondary:hover {
        background-color: #4e4e4e;
      }

      .preview-container {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .preview-tabs {
        background-color: #2d2d2d;
        padding: 10px 15px;
        display: flex;
        gap: 20px;
        border-bottom: 1px solid #3e3e3e;
      }

      .tab {
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .tab.active {
        background-color: #3e3e3e;
      }

      .tab:hover {
        background-color: #3e3e3e;
      }

      .preview-content {
        flex: 1;
        overflow: auto;
        padding: 20px;
        background-color: #1e1e1e;
        position: relative;
      }

      #previewFrame {
        width: 100%;
        height: 100%;
        border: none;
        background-color: white;
        border-radius: 8px;
      }

      #sourceCode {
        display: none;
        width: 100%;
        height: 100%;
        background-color: #1e1e1e;
        color: #e0e0e0;
        border: 1px solid #3e3e3e;
        border-radius: 6px;
        padding: 15px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 13px;
        resize: none;
        line-height: 1.5;
      }

      /* Simple CSS syntax highlighting */
      .css-comment {
        color: #6a9955;
      }

      .css-selector {
        color: #569cd6;
      }

      .css-property {
        color: #9cdcfe;
      }

      .css-value {
        color: #ce9178;
      }

      .css-variable {
        color: #4ec9b0;
      }

      .thinking-summary {
        display: none;
        background-color: #2d2d2d;
        border: 1px solid #3e3e3e;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .thinking-summary h3 {
        margin-bottom: 10px;
        color: #0e639c;
      }

      .thinking-summary pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 14px;
        line-height: 1.6;
      }

      .status-bar {
        background-color: #2d2d2d;
        padding: 10px 15px;
        border-top: 1px solid #3e3e3e;
        font-size: 12px;
        color: #888;
        display: flex;
        justify-content: space-between;
      }

      /* Old loading styles removed - using enhanced loader */

      .spinner {
        border: 3px solid #3e3e3e;
        border-top: 3px solid #0e639c;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Enhanced Loader Styles */
      .enhanced-loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 600px;
      }

      .loader-content {
        background: rgba(45, 45, 45, 0.95);
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      .loader-animation {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto 30px;
      }

      .loading .spinner {
        width: 80px;
        height: 80px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top-color: #0e639c;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        position: absolute;
        top: 0;
        left: 0;
      }

      .pulse-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 2px solid #0e639c;
        animation: pulse 2s ease-out infinite;
      }

      @keyframes pulse {
        0% {
          transform: translate(-50%, -50%) scale(0.8);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50%) scale(1.4);
          opacity: 0;
        }
      }

      .loader-title {
        text-align: center;
        margin: 0 0 30px;
        font-size: 24px;
        font-weight: 300;
        color: #e0e0e0;
        letter-spacing: 0.5px;
      }

      .loader-steps {
        margin-bottom: 30px;
      }

      .step {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        opacity: 0.4;
        transition: all 0.3s ease;
      }

      .step.active {
        opacity: 1;
      }

      .step.completed {
        opacity: 0.8;
      }

      .step.completed .step-status {
        opacity: 1;
      }

      .step-icon {
        margin-right: 15px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease;
      }

      .step-icon svg {
        width: 24px;
        height: 24px;
        color: #0e639c;
        transition: all 0.3s ease;
      }

      .step.active .step-icon svg {
        color: #1e88e5;
        transform: scale(1.1);
      }

      .step.completed .step-icon svg {
        color: #4caf50;
      }

      .step.active .step-icon {
        animation: iconPulse 2s ease infinite;
      }

      @keyframes iconPulse {
        0%,
        100% {
          transform: translateY(0) scale(1);
          filter: drop-shadow(0 2px 4px rgba(14, 99, 156, 0.2));
        }
        50% {
          transform: translateY(-3px) scale(1.05);
          filter: drop-shadow(0 4px 8px rgba(14, 99, 156, 0.3));
        }
      }

      .step-text {
        flex: 1;
        font-size: 16px;
        color: #e0e0e0;
      }

      .step-status {
        width: 20px;
        height: 20px;
        margin-left: 15px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .step.completed .step-status::after {
        content: '‚úì';
        color: #4caf50;
        font-size: 18px;
      }

      .loader-progress {
        margin-bottom: 25px;
      }

      .progress-bar {
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #0e639c, #1e88e5);
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 3px;
        position: relative;
        overflow: hidden;
      }

      .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .progress-text {
        text-align: center;
        font-size: 14px;
        color: #888;
      }

      .loader-tip {
        background: rgba(14, 99, 156, 0.1);
        border: 1px solid rgba(14, 99, 156, 0.3);
        border-radius: 8px;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        animation: fadeIn 1s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .tip-icon {
        margin-right: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .tip-icon svg {
        width: 20px;
        height: 20px;
        color: #1e88e5;
      }

      .tip-text {
        flex: 1;
        font-size: 14px;
        color: #e0e0e0;
        line-height: 1.4;
      }

      .loader-status {
        text-align: center;
        font-size: 14px;
        color: #888;
        font-style: italic;
      }

      /* Update loading display style */
      .loading {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(30, 30, 30, 0.98);
        backdrop-filter: blur(10px);
        z-index: 100;
        align-items: center;
        justify-content: center;
      }

      /* Dark scrollbar */
      ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }

      ::-webkit-scrollbar-track {
        background-color: #1e1e1e;
        border-radius: 6px;
      }

      ::-webkit-scrollbar-thumb {
        background-color: #3e3e3e;
        border-radius: 6px;
        border: 2px solid #1e1e1e;
      }

      ::-webkit-scrollbar-thumb:hover {
        background-color: #4e4e4e;
      }

      /* Animations */
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      .extracted-guidelines {
        margin-top: 10px;
        max-height: 300px;
        overflow-y: auto;
      }

      .guidelines-preview {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 15px;
      }

      .guideline-section {
        margin-bottom: 20px;
      }

      .guideline-section:last-child {
        margin-bottom: 0;
      }

      .guideline-section h4 {
        color: var(--text-primary);
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: 600;
      }

      .guideline-section ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .guideline-section li {
        padding: 4px 0;
        color: var(--text-secondary);
        font-size: 13px;
      }

      .guideline-section li strong {
        color: var(--text-primary);
      }

      .confidence {
        font-size: 11px;
        color: var(--text-muted);
        font-style: italic;
      }

      .no-guidelines {
        color: var(--text-muted);
        text-align: center;
        padding: 20px;
      }

      .more {
        color: var(--text-muted);
        font-style: italic;
      }

      #applyGuidelinesContainer {
        background: var(--bg-secondary);
        padding: 10px;
        border-radius: 6px;
      }

      #applyGuidelinesContainer label {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        font-size: 14px;
        cursor: pointer;
      }

      #applyGuidelinesContainer input[type='checkbox'] {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <div class="toolbar-title">Export Preview</div>
      <div class="toolbar-actions">
        <button class="btn-secondary" id="regenerateBtn" onclick="regenerate()" style="display: none">
          üîÑ Regenerate
        </button>
        <div style="display: inline-flex; align-items: center; margin: 0 10px">
          <select
            id="styleGuideDropdown"
            class="btn-secondary"
            style="
              padding: 8px 32px 8px 12px;
              appearance: none;
              background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27%23e0e0e0%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e');
              background-repeat: no-repeat;
              background-position: right 8px center;
              background-size: 16px;
              min-width: 200px;
            "
            onchange="handleStyleGuideChange(this.value)"
          >
            <option value="">üé® Select Style Guide</option>
            <option value="default">üìê Default (Journey Map)</option>
            <option value="view-guide">üëÅÔ∏è View Style Guide</option>
            <option value="" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
            <option value="add-new" style="font-weight: 600">‚ûï Add New Style...</option>
          </select>
        </div>
        <div
          style="
            display: inline-block;
            width: 1px;
            height: 24px;
            background: #3e3e3e;
            margin: 0 10px;
            vertical-align: middle;
          "
        ></div>
        <button class="btn-primary" onclick="saveToSpace()">üì• Save to Space</button>
        <button class="btn-secondary" onclick="saveAsHTML()">üíæ Export HTML</button>
        <button class="btn-secondary" onclick="exportAsPDF()">üìÑ Export PDF</button>
      </div>
    </div>

    <div class="preview-tabs">
      <div class="tab active" onclick="showTab('preview')">Preview</div>
      <div class="tab" onclick="showTab('source')">Source Code</div>
      <div class="tab" onclick="showTab('styleguide')">Style Guide</div>
      <div class="tab" onclick="showTab('thinking')" id="thinkingTab" style="display: none">AI Thinking</div>
    </div>

    <div class="preview-container">
      <div class="preview-content">
        <div class="thinking-summary" id="thinkingSummary">
          <h3>AI Thinking Process</h3>
          <pre id="thinkingContent"></pre>
        </div>

        <iframe id="previewFrame"></iframe>
        <textarea id="sourceCode" spellcheck="false"></textarea>

        <div id="styleGuideContent" style="display: none; width: 100%; height: 100%; overflow: auto">
          <div style="padding: 20px">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center">
              <div>
                <h3 style="margin: 0 0 10px 0; color: #0e639c">Current Style Guide</h3>
                <p style="margin: 0; color: #888; font-size: 14px" id="styleGuideName">Default (Journey Map)</p>
              </div>
              <div style="display: flex; gap: 10px">
                <button
                  onclick="toggleStyleGuideView()"
                  class="btn-secondary"
                  id="toggleViewBtn"
                  style="padding: 8px 16px; font-size: 13px"
                >
                  üîß View Source
                </button>
                <button onclick="copyStyleGuideCSS()" class="btn-secondary" style="padding: 8px 16px; font-size: 13px">
                  üìã Copy CSS
                </button>
              </div>
            </div>

            <!-- Style Guide Preview -->
            <div id="styleGuidePreview" style="display: block">
              <iframe
                id="stylePreviewFrame"
                style="
                  width: 100%;
                  height: calc(100vh - 250px);
                  border: 1px solid #3e3e3e;
                  border-radius: 6px;
                  background: white;
                "
              ></iframe>
            </div>

            <!-- Style Guide Source -->
            <div id="styleGuideSource" style="display: none">
              <div style="display: flex; justify-content: flex-end; margin-bottom: 10px">
                <button
                  onclick="editStyleGuideCSS()"
                  class="btn-secondary"
                  id="editCSSBtn"
                  style="padding: 6px 12px; font-size: 13px"
                >
                  ‚úèÔ∏è Edit
                </button>
              </div>
              <pre
                id="styleGuideCSS"
                style="
                  background-color: #1e1e1e;
                  color: #e0e0e0;
                  border: 1px solid #3e3e3e;
                  border-radius: 6px;
                  padding: 20px;
                  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                  font-size: 13px;
                  line-height: 1.5;
                  white-space: pre-wrap;
                  word-wrap: break-word;
                  max-width: 100%;
                  overflow-x: auto;
                  display: block;
                "
              ></pre>
              <textarea
                id="styleGuideCSSEdit"
                style="
                  display: none;
                  width: 100%;
                  height: calc(100vh - 300px);
                  background-color: #1e1e1e;
                  color: #e0e0e0;
                  border: 1px solid #3e3e3e;
                  border-radius: 6px;
                  padding: 20px;
                  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                  font-size: 13px;
                  line-height: 1.5;
                  resize: none;
                "
                spellcheck="false"
              ></textarea>
            </div>
          </div>
        </div>

        <div class="loading" id="loadingIndicator">
          <div class="enhanced-loader">
            <div class="loader-content">
              <div class="loader-animation">
                <div class="spinner"></div>
                <div class="pulse-ring"></div>
              </div>

              <h3 class="loader-title">Generating Your Export</h3>

              <div class="loader-steps">
                <div class="step" id="step-analyzing">
                  <div class="step-icon">
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M21 21l-6-6m6 6l-3.5-3.5" />
                      <circle cx="10" cy="10" r="8" />
                      <path d="M10 6v8m-4-4h8" />
                    </svg>
                  </div>
                  <div class="step-text">Analyzing content structure...</div>
                  <div class="step-status"></div>
                </div>

                <div class="step" id="step-preparing">
                  <div class="step-icon">
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M12 2L2 7l10 5 10-5-10-5z" />
                      <path d="M2 17l10 5 10-5M2 12l10 5 10-5" />
                    </svg>
                  </div>
                  <div class="step-text">Preparing style templates...</div>
                  <div class="step-status"></div>
                </div>

                <div class="step" id="step-ai">
                  <div class="step-icon">
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M12 2a10 10 0 1 0 0 20 10 10 0 1 0 0-20z" />
                      <path d="M12 8v8m-4-4h8" />
                      <circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.2" />
                      <path d="M12 2v4m0 12v4M22 12h-4M6 12H2" stroke-width="1" opacity="0.5" />
                    </svg>
                  </div>
                  <div class="step-text">AI processing your content...</div>
                  <div class="step-status"></div>
                </div>

                <div class="step" id="step-formatting">
                  <div class="step-icon">
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                      />
                      <path d="M12 2v16" stroke-width="1" opacity="0.3" />
                    </svg>
                  </div>
                  <div class="step-text">Formatting and polishing...</div>
                  <div class="step-status"></div>
                </div>
              </div>

              <div class="loader-progress">
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
              </div>

              <div class="loader-tip" id="loaderTip">
                <div class="tip-icon">
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M9 18h6m-3-16C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.87-3.13-7-7-7z"
                    />
                    <path d="M12 9v3" stroke-width="2" />
                  </svg>
                </div>
                <div class="tip-text" id="tipText">
                  Did you know? AI can adapt writing style based on your selected template!
                </div>
              </div>

              <div class="loader-status" id="loaderStatus">Initializing...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <div id="statusText">Ready</div>
      <div id="metadata"></div>
    </div>

    <script>
      let currentHTML = '';
      let currentTab = 'preview';
      let exportData = null;
      let isAIMode = false;
      let currentStyleGuideCSS = '';
      let currentStyleGuideName = 'Default (Journey Map)';

      // Helper function to escape HTML
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Initialize
      window.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded, window.api:', window.api);

        // Load saved style guides
        loadStyleGuides();

        // Load default style guide CSS
        loadDefaultStyleGuide();

        // Get export data from query params or IPC
        loadExportData();
      });

      async function loadDefaultStyleGuide() {
        try {
          // Load the default style guide CSS
          const response = await fetch('smart-export-styles.css');
          if (response.ok) {
            currentStyleGuideCSS = await response.text();
            updateStyleGuideDisplay('Default (Journey Map)', currentStyleGuideCSS);
          }
        } catch (error) {
          console.error('Error loading default style guide:', error);
        }
      }

      function updateStyleGuideDisplay(name, css) {
        currentStyleGuideName = name;
        currentStyleGuideCSS = css;

        document.getElementById('styleGuideName').textContent = name;
        document.getElementById('styleGuideCSS').textContent = css;
        document.getElementById('styleGuideCSSEdit').value = css;

        // Update the preview
        updateStyleGuidePreview();
      }

      function updateStyleGuidePreview() {
        const iframe = document.getElementById('stylePreviewFrame');
        if (!iframe) return;

        // Create a comprehensive style guide preview HTML
        const previewHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Style Guide Preview</title>
    <style>
        ${currentStyleGuideCSS}
        
        /* Preview-specific styles - minimal overrides */
        body {
            margin: 0;
            padding: 40px;
            min-height: 100vh;
        }
        
        .preview-section {
            margin-bottom: 60px;
            padding-bottom: 40px;
            border-bottom: 1px solid var(--color-border, #e0e0e0);
        }
        
        .preview-section:last-child {
            border-bottom: none;
        }
        
        .preview-label {
            display: inline-block;
            background: var(--color-secondary, #f0f0f0);
            color: var(--color-text, #666);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            margin-bottom: 15px;
        }
        
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .color-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .color-swatch {
            height: 80px;
            border-radius: 8px;
            border: 1px solid var(--color-border, #e0e0e0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
        }
        
        .color-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .color-name {
            font-weight: 500;
        }
        
        .color-value {
            font-family: monospace;
            color: var(--color-text-secondary, #666);
            font-size: 12px;
        }
        
        .spacing-demo {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            margin-top: 20px;
        }
        
        .spacing-item {
            text-align: center;
        }
        
        .spacing-box {
            background: #8B8B8B;
            opacity: 0.8;
            margin-bottom: 8px;
        }
        
        .type-sample {
            margin-bottom: 2rem;
            padding: 1rem;
            background: white;
            border: 1px solid var(--color-border, #e0e0e0);
        }
        
        .type-label {
            font-family: monospace;
            font-size: 11px;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .spacing-label {
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }
        
        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }
        
        .component-example {
            margin-bottom: 3rem;
        }
        
        .example-label {
            font-family: monospace;
            font-size: 11px;
            color: #999;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .demo-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .demo-button {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .button-primary {
            background: var(--color-primary, #3B82F6);
            color: white;
        }
        
        .button-primary:hover {
            background: var(--color-primary-dark, #2563EB);
        }
        
        .button-secondary {
            background: var(--color-secondary, #10B981);
            color: white;
        }
        
        .button-outline {
            background: transparent;
            color: var(--color-primary, #3B82F6);
            border: 2px solid var(--color-primary, #3B82F6);
        }
        
        .demo-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text, #2C2C2C);
        }
        
        .form-input {
            padding: 10px;
            border: 1px solid var(--color-border, #e0e0e0);
            border-radius: 6px;
            font-size: 14px;
            background: var(--color-input-bg, white);
            color: var(--color-text, #2C2C2C);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--color-primary, #3B82F6);
            box-shadow: 0 0 0 3px var(--color-primary-light, rgba(59, 130, 246, 0.1));
        }
        
        .alert-demo {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-info {
            background: var(--color-info-bg, #EFF6FF);
            color: var(--color-info, #2563EB);
            border: 1px solid var(--color-info-border, #DBEAFE);
        }
        
        .alert-success {
            background: var(--color-success-bg, #F0FDF4);
            color: var(--color-success, #15803D);
            border: 1px solid var(--color-success-border, #BBF7D0);
        }
        
        .alert-warning {
            background: var(--color-warning-bg, #FFFBEB);
            color: var(--color-warning, #B45309);
            border: 1px solid var(--color-warning-border, #FED7AA);
        }
        
        .alert-error {
            background: var(--color-error-bg, #FEF2F2);
            color: var(--color-error, #DC2626);
            border: 1px solid var(--color-error-border, #FECACA);
        }
        
        .shadow-demo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .shadow-box {
            background: var(--color-surface, white);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            color: var(--color-text-secondary, #666);
        }
        
        .shadow-sm { box-shadow: var(--shadow-sm, 0 1px 2px 0 rgba(0, 0, 0, 0.05)); }
        .shadow-md { box-shadow: var(--shadow-md, 0 4px 6px -1px rgba(0, 0, 0, 0.1)); }
        .shadow-lg { box-shadow: var(--shadow-lg, 0 10px 15px -3px rgba(0, 0, 0, 0.1)); }
        .shadow-xl { box-shadow: var(--shadow-xl, 0 20px 25px -5px rgba(0, 0, 0, 0.1)); }
    </style>
</head>
<body class="smart-export-document">
    <!-- Document Header Example -->
    <div class="document-header">
        <h1 class="document-title">Style Guide Preview</h1>
        <div class="document-meta">
            <span class="document-date">${new Date().toLocaleDateString()}</span>
            <span class="document-context">Smart Export Styles</span>
        </div>
    </div>

    <!-- Colors Section - Using actual style guide classes -->
    <div class="preview-section">
        <h2 class="section-header">Color Palette</h2>
        <div class="color-grid">
            <!-- Journey Map Core Colors -->
            <div class="color-item">
                <div class="color-swatch" style="background: var(--color-background, #F5F2ED); color: var(--color-text, #2C2C2C); border: 1px solid var(--color-border);">
                    Background
                </div>
                <div class="color-info">
                    <span class="color-name">Background</span>
                    <span class="color-value">#F5F2ED</span>
                </div>
            </div>
            
            <div class="color-item">
                <div class="color-swatch" style="background: var(--color-text, #2C2C2C); color: white;">
                    Primary Text
                </div>
                <div class="color-info">
                    <span class="color-name">Primary Text</span>
                    <span class="color-value">#2C2C2C</span>
                </div>
            </div>
            
            <div class="color-item">
                <div class="color-swatch" style="background: var(--color-text-secondary, #666666); color: white;">
                    Secondary Text
                </div>
                <div class="color-info">
                    <span class="color-name">Secondary Text</span>
                    <span class="color-value">#5A5A5A</span>
                </div>
            </div>
            
            <div class="color-item">
                <div class="color-swatch" style="background: var(--color-border, #E5E7EB); color: var(--color-text, #2C2C2C);">
                    Lines/Borders
                </div>
                <div class="color-info">
                    <span class="color-name">Lines/Borders</span>
                    <span class="color-value">#D4D4D4</span>
                </div>
            </div>
            
            <!-- Accent Colors -->
            <div class="color-item">
                <div class="color-swatch" style="background: var(--color-primary, #3B82F6); color: white;">
                    Primary Accent
                </div>
                <div class="color-info">
                    <span class="color-name">Primary</span>
                    <span class="color-value">#3B82F6</span>
                </div>
            </div>
            
            <div class="color-item">
                <div class="color-swatch" style="background: var(--color-secondary, #10B981); color: white;">
                    Secondary Accent
                </div>
                <div class="color-info">
                    <span class="color-name">Secondary</span>
                    <span class="color-value">#10B981</span>
                </div>
            </div>
            
            <div class="color-item">
                <div class="color-swatch" style="background: var(--color-accent, #F59E0B); color: white;">
                    Accent
                </div>
                <div class="color-info">
                    <span class="color-name">Accent</span>
                    <span class="color-value">#F59E0B</span>
                </div>
            </div>
            
            <div class="color-item">
                <div class="color-swatch" style="background: #8B8B8B; color: white;">
                    Accent Dots
                </div>
                <div class="color-info">
                    <span class="color-name">Accent Dots</span>
                    <span class="color-value">#8B8B8B</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Typography Section -->
    <div class="preview-section">
        <h2 class="section-header">Typography</h2>
        
        <div class="type-sample">
            <div class="type-label">Document Title (.document-title) - Crimson Text, 3rem</div>
            <h1 class="document-title">Journey Map Title</h1>
        </div>
        
        <div class="type-sample">
            <div class="type-label">Section Header (.section-header) - Crimson Text, 1.5rem</div>
            <h2 class="section-header">Section Header</h2>
        </div>
        
        <div class="type-sample">
            <div class="type-label">Card Title (.card-title) - Crimson Text, 1.125rem</div>
            <h3 class="card-title">Card Title</h3>
        </div>
        
        <div class="type-sample">
            <div class="type-label">Body Text (.body-text) - Crimson Text, 1rem</div>
            <p class="body-text">
                This is body text using the Crimson Text serif font. It has a line height of 1.8 for optimal readability. The warm typography creates an elegant, sophisticated feeling that matches the journey map aesthetic.
            </p>
        </div>
        
        <div class="type-sample">
            <div class="type-label">Emphasized Text (.emphasized-text) - Crimson Text Italic, 1.125rem</div>
            <p class="emphasized-text">
                This emphasized text stands out with italic styling and slightly larger size.
            </p>
        </div>
        
        <div class="type-sample">
            <div class="type-label">Quote Block (.quote-block)</div>
            <div class="quote-block">
                "This is a quote block with italic text and a subtle left border. It's perfect for highlighting important excerpts or testimonials."
            </div>
        </div>
    </div>
    
    <!-- Spacing System -->
    <div class="preview-section">
        <h2 class="section-header">Spacing System</h2>
        
        <div class="spacing-demo" style="margin-bottom: 1rem;">
            <div class="spacing-box" style="width: var(--spacing-xs, 0.25rem); height: 40px; display: inline-block; vertical-align: middle;"></div>
            <span class="spacing-label" style="margin-left: 1rem;">xs: 0.25rem (4px)</span>
        </div>
        <div class="spacing-demo" style="margin-bottom: 1rem;">
            <div class="spacing-box" style="width: var(--spacing-sm, 0.5rem); height: 40px; display: inline-block; vertical-align: middle;"></div>
            <span class="spacing-label" style="margin-left: 1rem;">sm: 0.5rem (8px)</span>
        </div>
        <div class="spacing-demo" style="margin-bottom: 1rem;">
            <div class="spacing-box" style="width: var(--spacing-md, 1rem); height: 40px; display: inline-block; vertical-align: middle;"></div>
            <span class="spacing-label" style="margin-left: 1rem;">md: 1rem (16px)</span>
        </div>
        <div class="spacing-demo" style="margin-bottom: 1rem;">
            <div class="spacing-box" style="width: var(--spacing-lg, 2rem); height: 40px; display: inline-block; vertical-align: middle;"></div>
            <span class="spacing-label" style="margin-left: 1rem;">lg: 2rem (32px)</span>
        </div>
        <div class="spacing-demo" style="margin-bottom: 1rem;">
            <div class="spacing-box" style="width: var(--spacing-xl, 3rem); height: 40px; display: inline-block; vertical-align: middle;"></div>
            <span class="spacing-label" style="margin-left: 1rem;">xl: 3rem (48px)</span>
        </div>
        <div class="spacing-demo" style="margin-bottom: 1rem;">
            <div class="spacing-box" style="width: var(--spacing-xxl, 4rem); height: 40px; display: inline-block; vertical-align: middle;"></div>
            <span class="spacing-label" style="margin-left: 1rem;">xxl: 4rem (64px)</span>
        </div>
    </div>
    
    <!-- Components Section -->
    <div class="preview-section">
        <h2 class="section-header">Components</h2>
        
        <!-- Content Card -->
        <div class="component-example">
            <div class="example-label">Content Card (.content-card)</div>
            <div class="content-card">
                <h3 class="card-title">Content Card Example</h3>
                <p class="body-text">
                    Content cards have a subtle border and generous padding. They're perfect for grouping related information.
                </p>
            </div>
        </div>
        
        <!-- Insight Card -->
        <div class="component-example">
            <div class="example-label">Insight Card (.insight-card)</div>
            <div class="insight-card">
                <h3 class="card-title">Key Insight</h3>
                <p class="body-text">
                    Insight cards are used for highlighting important findings or conclusions.
                </p>
            </div>
        </div>
        
        <!-- Table -->
        <div class="component-example">
            <div class="example-label">Styled Table (.styled-table)</div>
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>Stage</th>
                        <th>Description</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Awareness</td>
                        <td>User discovers the need</td>
                        <td>1-2 days</td>
                    </tr>
                    <tr>
                        <td>Consideration</td>
                        <td>Evaluating options</td>
                        <td>3-5 days</td>
                    </tr>
                    <tr>
                        <td>Decision</td>
                        <td>Making the choice</td>
                        <td>1 day</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Timeline Components -->
    <div class="preview-section">
        <h2 class="section-header">Timeline Components</h2>
        
        <div class="component-example">
            <div class="example-label">Timeline (.timeline-container)</div>
            <div class="timeline-container">
                <div class="timeline-line"></div>
                <div class="timeline-stages">
                    <div class="timeline-stage">
                        <div class="timeline-marker"></div>
                        Awareness
                    </div>
                    <div class="timeline-stage">
                        <div class="timeline-marker"></div>
                        Consideration
                    </div>
                    <div class="timeline-stage">
                        <div class="timeline-marker"></div>
                        Purchase
                    </div>
                    <div class="timeline-stage">
                        <div class="timeline-marker"></div>
                        Support
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- List Styles -->
    <div class="preview-section">
        <h2 class="section-header">Lists</h2>
        
        <div class="component-example">
            <div class="example-label">Styled List (.styled-list)</div>
            <ul class="styled-list">
                <li>First item with custom bullet</li>
                <li>Second item maintaining consistent spacing</li>
                <li>Third item in elegant serif typography</li>
            </ul>
        </div>
    </div>
    
    <!-- Grid Layouts -->
    <div class="preview-section">
        <h2 class="section-header">Grid Layouts</h2>
        
        <div class="component-example">
            <div class="example-label">Opportunity Grid (.opportunity-grid)</div>
            <div class="opportunity-grid">
                <div class="opportunity-cell">
                    <div class="opportunity-dot"></div>
                </div>
                <div class="opportunity-cell"></div>
                <div class="opportunity-cell">
                    <div class="opportunity-dot"></div>
                </div>
                <div class="opportunity-cell"></div>
                <div class="opportunity-cell"></div>
                <div class="opportunity-cell">
                    <div class="opportunity-dot"></div>
                </div>
                <div class="opportunity-cell"></div>
                <div class="opportunity-cell">
                    <div class="opportunity-dot"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Utility Classes -->
    <div class="preview-section">
        <h2 class="section-header">Utility Classes</h2>
        
        <div class="grid-demo" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
            <div class="grid-item" style="background: rgba(0, 0, 0, 0.05); padding: 2rem; text-align: center; border-radius: 4px;">
                <p class="text-center">.text-center</p>
            </div>
            <div class="grid-item" style="background: rgba(0, 0, 0, 0.05); padding: 2rem; text-align: center; border-radius: 4px;">
                <p class="text-right">.text-right</p>
            </div>
            <div class="grid-item" style="background: rgba(0, 0, 0, 0.05); padding: 2rem; text-align: center; border-radius: 4px;">
                <p class="text-muted">.text-muted</p>
            </div>
            <div class="grid-item" style="background: rgba(0, 0, 0, 0.05); padding: 2rem; text-align: center; border-radius: 4px;">
                <p>.mb-lg (margin bottom)</p>
            </div>
        </div>
    </div>
    
    <!-- Metrics & Data -->
    <div class="preview-section">
        <h2 class="section-header">Metrics & Data</h2>
        
        <div class="component-example">
            <div class="content-card text-center">
                <div class="metric-display">87%</div>
                <div class="metric-label">Customer Satisfaction</div>
            </div>
        </div>
    </div>
    
    <!-- Usage Examples -->
    <div class="preview-section">
        <h2 class="section-header">Usage Examples</h2>
        
        <div class="content-card">
            <h3 class="card-title">Complete Component Example</h3>
            <p class="body-text mb-md">
                This demonstrates how components work together to create a cohesive design.
            </p>
            <ul class="styled-list mb-lg">
                <li>Consistent spacing using utility classes</li>
                <li>Proper typography hierarchy</li>
                <li>Subtle borders and backgrounds</li>
            </ul>
            <div class="quote-block">
                "The journey map aesthetic creates documents that feel both professional and approachable."
            </div>
        </div>
    </div>
    
    <!-- Navigation -->
    <div class="document-navigation">
        <a href="#" class="nav-arrow">‚Üê</a>
        <span class="page-indicator">Smart Export Style Guide v1.0</span>
        <a href="#" class="nav-arrow">‚Üí</a>
    </div>
</body>
</html>
            `;

        iframe.srcdoc = previewHTML;
      }

      function toggleStyleGuideView() {
        const preview = document.getElementById('styleGuidePreview');
        const source = document.getElementById('styleGuideSource');
        const toggleBtn = document.getElementById('toggleViewBtn');

        if (preview.style.display === 'block') {
          // Switch to source view
          preview.style.display = 'none';
          source.style.display = 'block';
          toggleBtn.innerHTML = 'üëÅÔ∏è View Preview';
        } else {
          // Switch to preview view
          preview.style.display = 'block';
          source.style.display = 'none';
          toggleBtn.innerHTML = 'üîß View Source';

          // Update preview in case CSS was edited
          updateStyleGuidePreview();
        }
      }

      function editStyleGuideCSS() {
        const cssDisplay = document.getElementById('styleGuideCSS');
        const cssEdit = document.getElementById('styleGuideCSSEdit');
        const editBtn = document.getElementById('editCSSBtn');

        if (cssEdit.style.display === 'none') {
          // Enter edit mode
          cssDisplay.style.display = 'none';
          cssEdit.style.display = 'block';
          editBtn.innerHTML = '‚úì Save';
          editBtn.style.background = '#4caf50';
          cssEdit.focus();
        } else {
          // Save and exit edit mode
          cssDisplay.style.display = 'block';
          cssEdit.style.display = 'none';
          editBtn.innerHTML = '‚úèÔ∏è Edit';
          editBtn.style.background = '';

          // Update the CSS
          currentStyleGuideCSS = cssEdit.value;
          cssDisplay.textContent = currentStyleGuideCSS;

          // Apply the edited CSS to current export if in preview
          if (currentTab === 'preview' || currentTab === 'source') {
            applyCustomStyles(currentStyleGuideCSS, currentStyleGuideName);
          }
        }
      }

      async function copyStyleGuideCSS() {
        try {
          await navigator.clipboard.writeText(currentStyleGuideCSS);

          // Show feedback
          const button = event.target;
          const originalText = button.textContent;
          button.textContent = '‚úì Copied!';
          button.style.background = '#4caf50';

          setTimeout(() => {
            button.textContent = originalText;
            button.style.background = '';
          }, 2000);
        } catch (error) {
          console.error('Error copying CSS:', error);
          showError('Failed to copy CSS');
        }
      }

      async function loadExportData() {
        console.log('loadExportData called');

        try {
          // Get space data passed from the main window
          const spaceData = await window.api.getSmartExportData();
          console.log('Smart export data received:', spaceData);

          if (spaceData) {
            isAIMode = spaceData.useAI || false;

            // Update UI based on mode
            if (isAIMode) {
              document.getElementById('regenerateBtn').style.display = 'inline-block';
              await generateSmartExport(spaceData);
            } else {
              document.getElementById('regenerateBtn').style.display = 'none';
              await generateBasicExport(spaceData);
            }
          } else {
            console.warn('No space data received');
            showError('No space data available');
          }
        } catch (error) {
          console.error('Error loading export data:', error);
          showError(error.message);
        }
      }

      async function generateBasicExport(spaceData) {
        console.log('generateBasicExport called with:', spaceData);
        showLoading(true);
        updateStatus('Generating basic export...');

        try {
          // Step 1: Analyzing
          setTimeout(() => {
            updateLoadingStep('analyzing', true);
            updateLoaderStatus('Analyzing content structure...');
          }, 300);

          // Step 2: Complete analyzing, start preparing
          setTimeout(() => {
            updateLoadingStep('analyzing', false, true);
            updateLoadingStep('preparing', true);
            updateLoaderStatus('Preparing document template...');
          }, 1000);

          // Generate basic HTML without AI
          const result = await window.api.generateBasicExport(spaceData);
          console.log('Basic export result:', result);

          if (!result || !result.html) {
            throw new Error('No HTML content received from export generator');
          }

          // Step 3: Skip AI, go to formatting
          updateLoadingStep('preparing', false, true);
          updateLoadingStep('formatting', true);
          updateLoaderStatus('Applying formatting and styles...');

          currentHTML = result.html;
          exportData = result;

          // Update preview after short delay
          setTimeout(() => {
            updateLoadingStep('formatting', false, true);
            updateProgressBar(100);
            updateLoaderStatus('Finalizing document...');

            // Update preview
            updatePreview(currentHTML);

            // Update metadata
            updateMetadata(result.metadata);

            updateStatus('Export generated successfully');

            setTimeout(() => {
              showLoading(false);
            }, 500);
          }, 1500);
        } catch (error) {
          console.error('Error generating basic export:', error);
          showError(error.message);
          showLoading(false);
        }
      }

      async function generateSmartExport(spaceData, template = null) {
        showLoading(true);
        updateStatus('Initializing AI generation...');

        try {
          // Step 1: Analyzing
          setTimeout(() => {
            updateLoadingStep('analyzing', true);
            updateLoaderStatus('Analyzing your content and context...');
          }, 300);

          // Step 2: Preparing
          setTimeout(() => {
            updateLoadingStep('analyzing', false, true);
            updateLoadingStep('preparing', true);
            const templateName = template?.name || 'selected template';
            updateLoaderStatus(`Preparing ${templateName}...`);
          }, 1500);

          // Step 3: AI Processing
          setTimeout(() => {
            updateLoadingStep('preparing', false, true);
            updateLoadingStep('ai', true);
            updateLoaderStatus('AI is crafting your document...');
          }, 3000);

          // Regular smart export generation
          const exportPayload = {
            ...spaceData,
            template: template,
          };

          const result = await window.api.generateSmartExport(exportPayload);

          // Step 4: Formatting
          updateLoadingStep('ai', false, true);
          updateLoadingStep('formatting', true);
          updateLoaderStatus('Applying final formatting and polish...');

          currentHTML = result.html;
          exportData = result;

          // Final steps with delay
          setTimeout(() => {
            updateLoadingStep('formatting', false, true);
            updateProgressBar(100);
            updateLoaderStatus('Finalizing your document...');

            setTimeout(() => {
              // Update preview
              updatePreview(currentHTML);

              // Update metadata
              updateMetadata(result.metadata);

              // Show thinking summary if available
              if (result.thinkingSummary) {
                document.getElementById('thinkingTab').style.display = 'block';
                document.getElementById('thinkingContent').textContent = result.thinkingSummary;
              }

              updateStatus('AI-enhanced export generated successfully');
              showLoading(false);
            }, 1000);
          }, 1500);
        } catch (error) {
          console.error('Error generating export:', error);
          showError(error.message);
          showLoading(false);
        }
      }

      function updatePreview(html) {
        console.log('updatePreview called with HTML of length:', html ? html.length : 0);
        const iframe = document.getElementById('previewFrame');

        if (!iframe) {
          console.error('Preview iframe not found');
          return;
        }

        try {
          // Set iframe srcdoc instead of using document.write
          // This is more reliable and avoids CSP issues
          iframe.srcdoc = html;

          console.log('HTML set via srcdoc successfully');

          // Initialize Mermaid diagrams once iframe loads
          iframe.onload = function () {
            try {
              const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

              // Check if iframe contains mermaid diagrams
              const mermaidElements = iframeDoc.querySelectorAll('.mermaid');
              if (mermaidElements.length > 0) {
                console.log(`Found ${mermaidElements.length} mermaid diagrams in iframe`);

                // Add Mermaid script to iframe if not already present
                if (!iframeDoc.querySelector('script[src*="mermaid"]')) {
                  const mermaidScript = iframeDoc.createElement('script');
                  mermaidScript.src = 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js';
                  mermaidScript.onload = function () {
                    iframe.contentWindow.mermaid.initialize({
                      startOnLoad: true,
                      theme: 'base',
                      themeVariables: {
                        primaryColor: '#3B82F6',
                        primaryTextColor: '#2C2C2C',
                        primaryBorderColor: '#3B82F6',
                        lineColor: '#6B7280',
                        secondaryColor: '#F5F2ED',
                        tertiaryColor: '#10B981',
                        background: '#FFFFFF',
                        mainBkg: '#FFFFFF',
                        secondBkg: '#F5F2ED',
                        tertiaryBkg: '#F3F4F6',
                        textColor: '#2C2C2C',
                        border1: '#E5E7EB',
                        border2: '#D1D5DB',
                        fontFamily: 'Inter, sans-serif',
                      },
                    });
                    iframe.contentWindow.mermaid.run();
                  };
                  iframeDoc.head.appendChild(mermaidScript);
                } else if (iframe.contentWindow.mermaid) {
                  // Mermaid already loaded, just run it
                  iframe.contentWindow.mermaid.run();
                }
              }
            } catch (error) {
              console.error('Error initializing Mermaid in iframe:', error);
            }
          };

          // Update source code view
          const sourceCodeEl = document.getElementById('sourceCode');
          if (sourceCodeEl) {
            sourceCodeEl.value = html;
          }
        } catch (error) {
          console.error('Error updating preview:', error);
          showError('Failed to update preview: ' + error.message);
        }
      }

      function updateMetadata(metadata) {
        const metadataEl = document.getElementById('metadata');

        if (!metadata) {
          metadataEl.textContent = 'No metadata available';
          return;
        }

        let metaText = `${metadata.itemCount || 0} items`;

        // Add summary indicator if content was summarized
        if (metadata.isSummary) {
          metaText = `‚ö†Ô∏è Summary: ${metadata.processedItemCount} of ${metadata.itemCount} items`;
        }

        if (metadata.model) {
          metaText += ` | ${metadata.model}`;
        }

        if (metadata.timestamp) {
          metaText += ` | ${new Date(metadata.timestamp).toLocaleString()}`;
        }

        metadataEl.textContent = metaText;

        // Add visual warning if content was summarized
        if (metadata.isSummary) {
          const warning = document.createElement('div');
          warning.className = 'summary-warning';
          warning.innerHTML = `
                    <div style="background: #ff6b6b; color: white; padding: 12px; margin: 10px 0; border-radius: 4px; text-align: center;">
                        <strong>‚ö†Ô∏è Large Space Summary</strong><br>
                        This space contains too much content to process in full. 
                        Showing ${metadata.processedItemCount} out of ${metadata.itemCount} items.
                    </div>
                `;

          const previewContent = document.querySelector('.preview-content');
          const existingWarning = previewContent.querySelector('.summary-warning');
          if (existingWarning) {
            existingWarning.remove();
          }
          previewContent.insertBefore(warning, previewContent.firstChild);
        }
      }

      function showTab(tab) {
        currentTab = tab;

        // Update tab styles
        document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
        event.target.classList.add('active');

        // Show/hide content
        const preview = document.getElementById('previewFrame');
        const source = document.getElementById('sourceCode');
        const styleGuide = document.getElementById('styleGuideContent');
        const thinking = document.getElementById('thinkingSummary');

        preview.style.display = tab === 'preview' ? 'block' : 'none';
        source.style.display = tab === 'source' ? 'block' : 'none';
        styleGuide.style.display = tab === 'styleguide' ? 'block' : 'none';
        thinking.style.display = tab === 'thinking' ? 'block' : 'none';

        // Update style guide preview when switching to that tab
        if (tab === 'styleguide') {
          updateStyleGuidePreview();
        }
      }

      async function regenerate() {
        if (exportData && exportData.spaceData) {
          if (isAIMode) {
            await generateSmartExport(exportData.spaceData);
          } else {
            await generateBasicExport(exportData.spaceData);
          }
        }
      }

      function showTemplateModal() {
        // Create modal HTML
        const modalHTML = `
                <div id="templateModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                ">
                    <div style="
                        background: #2d2d2d;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 900px;
                        max-height: 80vh;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    ">
                        <div style="
                            padding: 20px 30px;
                            border-bottom: 1px solid #3e3e3e;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h2 style="margin: 0; font-size: 20px; font-weight: 500;">Select Document Template</h2>
                            <button onclick="closeTemplateModal()" style="
                                background: none;
                                border: none;
                                color: #e0e0e0;
                                font-size: 24px;
                                cursor: pointer;
                                padding: 0;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border-radius: 4px;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#3e3e3e'" onmouseout="this.style.background='none'">√ó</button>
                        </div>
                        
                        <div style="
                            flex: 1;
                            overflow-y: auto;
                            padding: 20px;
                        ">
                            <div id="templateGrid" style="
                                display: grid;
                                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                                gap: 15px;
                            ">
                                <!-- Templates will be inserted here -->
                            </div>
                        </div>
                        
                        <div id="templatePreview" style="
                            display: none;
                            padding: 20px;
                            border-top: 1px solid #3e3e3e;
                            background: #1e1e1e;
                        ">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px;">Template Preview</h3>
                            <div id="templatePreviewContent" style="
                                background: #2d2d2d;
                                padding: 15px;
                                border-radius: 6px;
                                margin-bottom: 15px;
                                max-height: 200px;
                                overflow-y: auto;
                            "></div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-primary" onclick="useSelectedTemplate()">Use This Template</button>
                                <button class="btn-secondary" onclick="editTemplate()">Edit Template</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // Load templates
        loadTemplates();
      }

      async function loadTemplates() {
        const templates = await window.api.getExportTemplates();
        const templateGrid = document.getElementById('templateGrid');

        // Sort templates: WISER templates by order, then others
        const sortedTemplates = templates.sort((a, b) => {
          if (a.orderIndex !== undefined && b.orderIndex !== undefined) {
            return a.orderIndex - b.orderIndex;
          }
          if (a.orderIndex !== undefined) return -1;
          if (b.orderIndex !== undefined) return 1;
          return a.name.localeCompare(b.name);
        });

        templateGrid.innerHTML = sortedTemplates
          .map(
            (template) => `
                <div class="template-card" onclick="selectTemplate('${template.id}')" style="
                    background: #3e3e3e;
                    border-radius: 8px;
                    padding: 20px;
                    cursor: pointer;
                    transition: all 0.2s;
                    border: 2px solid transparent;
                    text-align: center;
                    position: relative;
                " onmouseover="this.style.background='#4e4e4e';this.style.borderColor='#0e639c'" 
                   onmouseout="this.style.background='#3e3e3e';this.style.borderColor='transparent'">
                    ${template.aiFirst ? '<div style="position: absolute; top: 10px; right: 10px; background: #00d4ff; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">AI FIRST</div>' : ''}
                    <div style="font-size: 32px; margin-bottom: 10px;">${template.icon}</div>
                    <div style="font-size: 14px; font-weight: 500;">${template.name}</div>
                    <div style="font-size: 12px; color: #888; margin-top: 5px;">${template.description}</div>
                </div>
            `
          )
          .join('');
      }

      let selectedTemplate = null;

      async function selectTemplate(templateId) {
        selectedTemplate = await window.api.getExportTemplate(templateId);

        // Show preview
        document.getElementById('templatePreview').style.display = 'block';
        document.getElementById('templatePreviewContent').innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>Template:</strong> ${selectedTemplate.name}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Description:</strong> ${selectedTemplate.description}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Prompt Preview:</strong>
                    <div style="background: #1e1e1e; padding: 10px; border-radius: 4px; margin-top: 5px; font-size: 12px; font-family: monospace;">
                        ${escapeHtml(selectedTemplate.prompt.substring(0, 200))}...
                    </div>
                </div>
            `;

        // Highlight selected card
        document.querySelectorAll('.template-card').forEach((card) => {
          card.style.borderColor = 'transparent';
        });
        event.currentTarget.style.borderColor = '#0e639c';
      }

      function closeTemplateModal() {
        document.getElementById('templateModal').remove();
      }

      async function useSelectedTemplate() {
        if (!selectedTemplate) return;

        // Close modal
        closeTemplateModal();

        // Switch to AI mode
        isAIMode = true;
        document.getElementById('regenerateBtn').style.display = 'inline-block';

        // Generate with AI using the selected template
        await generateSmartExport(exportData.spaceData, selectedTemplate);
      }

      function editTemplate() {
        // TODO: Implement template editor
        alert('Template editor coming soon!');
      }

      function editHTML() {
        showTab('source');
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('sourceCode').focus();
      }

      function openStyleGuide(customCSS = null, styleName = null) {
        // Open the style guide in a new window
        const styleGuideWindow = window.open(
          'smart-export-style-guide.html',
          'styleGuide',
          'width=1200,height=800,menubar=no,toolbar=no,location=no,status=no'
        );

        // Focus the window if it was already open
        if (styleGuideWindow) {
          styleGuideWindow.focus();

          // If custom CSS is provided, inject it after the window loads
          if (customCSS) {
            styleGuideWindow.addEventListener('load', () => {
              // Wait a bit for the page to fully initialize
              setTimeout(() => {
                // Inject the custom CSS
                const customStyle = styleGuideWindow.document.createElement('style');
                customStyle.id = 'custom-style-guide';
                customStyle.textContent = customCSS;
                styleGuideWindow.document.head.appendChild(customStyle);

                // Update the title if style name is provided
                if (styleName) {
                  const titleElement = styleGuideWindow.document.querySelector('.document-title');
                  if (titleElement) {
                    titleElement.textContent = `Style Guide - ${styleName}`;
                  }

                  // Also update the window title
                  styleGuideWindow.document.title = `Style Guide - ${styleName}`;
                }
              }, 100);
            });
          }
        }
      }

      function previewSelectedStyleGuide(id) {
        closeStyleGuideContextMenu();
        const guide = savedStyleGuides[id];
        if (guide && guide.css) {
          // Apply the style guide and switch to the Style Guide tab
          updateStyleGuideDisplay(guide.name, guide.css);
          showTab('styleguide');

          // Simulate tab click to ensure proper state
          const styleGuideTab = document.querySelector('.tab:nth-child(3)');
          if (styleGuideTab) {
            styleGuideTab.click();
          }
        }
      }

      async function saveAsHTML() {
        try {
          const html = currentTab === 'source' ? document.getElementById('sourceCode').value : currentHTML;

          const saved = await window.api.saveSmartExportHTML(html, exportData.metadata);

          if (saved) {
            updateStatus('HTML saved successfully');
          }
        } catch (error) {
          console.error('Error saving HTML:', error);
          showError('Failed to save HTML');
        }
      }

      async function exportAsPDF() {
        try {
          updateStatus('Exporting as PDF...');

          const html = currentTab === 'source' ? document.getElementById('sourceCode').value : currentHTML;

          const saved = await window.api.saveSmartExportPDF(html, exportData.metadata);

          if (saved) {
            updateStatus('PDF exported successfully');
          }
        } catch (error) {
          console.error('Error exporting PDF:', error);
          showError('Failed to export PDF');
        }
      }

      // Enhanced loading functions
      let loadingSteps = {
        analyzing: false,
        preparing: false,
        ai: false,
        formatting: false,
      };

      let loadingProgress = 0;
      let loadingTips = [
        'AI can adapt writing style based on your selected template!',
        'Your content is being optimized for maximum readability',
        'Smart export preserves all formatting and structure',
        'AI analyzes context to create cohesive documents',
        'Templates can be customized with your own style guides',
        'Export results improve with more content in your space',
        'You can extract styles from any website URL',
        'Content guidelines help maintain consistency',
      ];

      let currentTipIndex = 0;
      let tipRotationInterval = null;

      function showLoading(show) {
        const loader = document.getElementById('loadingIndicator');
        loader.style.display = show ? 'flex' : 'none';

        if (show) {
          resetLoadingSteps();
          startLoadingAnimation();
          rotateTips();
        } else {
          stopLoadingAnimation();
        }
      }

      function resetLoadingSteps() {
        loadingSteps = {
          analyzing: false,
          preparing: false,
          ai: false,
          formatting: false,
        };
        loadingProgress = 0;

        // Reset all step classes
        document.querySelectorAll('.step').forEach((step) => {
          step.classList.remove('active', 'completed');
        });

        updateProgressBar(0);
        document.getElementById('loaderStatus').textContent = 'Initializing...';
      }

      function startLoadingAnimation() {
        // Start with analyzing step
        setTimeout(() => updateLoadingStep('analyzing', true), 100);
      }

      function stopLoadingAnimation() {
        if (tipRotationInterval) {
          clearInterval(tipRotationInterval);
          tipRotationInterval = null;
        }
      }

      function updateLoadingStep(stepName, isActive = true, isCompleted = false) {
        const stepElement = document.getElementById(`step-${stepName}`);
        if (!stepElement) return;

        if (isCompleted) {
          stepElement.classList.remove('active');
          stepElement.classList.add('completed');
          loadingSteps[stepName] = true;
        } else if (isActive) {
          stepElement.classList.add('active');
        }

        // Update progress based on completed steps
        const completedCount = Object.values(loadingSteps).filter((v) => v).length;
        const totalSteps = Object.keys(loadingSteps).length;
        const progress = (completedCount / totalSteps) * 100;

        updateProgressBar(progress);
      }

      function updateProgressBar(percent) {
        loadingProgress = percent;
        const fill = document.getElementById('progressFill');
        const text = document.getElementById('progressText');

        if (fill) fill.style.width = `${percent}%`;
        if (text) text.textContent = `${Math.round(percent)}%`;
      }

      function updateLoaderStatus(status) {
        const statusElement = document.getElementById('loaderStatus');
        if (statusElement) {
          statusElement.textContent = status;
        }
      }

      function rotateTips() {
        // Change tip every 3 seconds
        tipRotationInterval = setInterval(() => {
          currentTipIndex = (currentTipIndex + 1) % loadingTips.length;
          const tipElement = document.getElementById('tipText');
          if (tipElement) {
            tipElement.style.animation = 'none';
            setTimeout(() => {
              tipElement.textContent = loadingTips[currentTipIndex];
              tipElement.style.animation = 'fadeIn 1s ease';
            }, 50);
          }
        }, 3000);
      }

      function updateStatus(text) {
        document.getElementById('statusText').textContent = text;

        // Also update loader status if loading
        const loader = document.getElementById('loadingIndicator');
        if (loader && loader.style.display !== 'none') {
          updateLoaderStatus(text);
        }
      }

      function showError(message) {
        updateStatus(`Error: ${message}`);
        document.getElementById('statusText').style.color = '#f44336';
        setTimeout(() => {
          document.getElementById('statusText').style.color = '#888';
        }, 5000);
      }

      async function saveToSpace() {
        console.log('Save to Space button clicked');
        try {
          // Show space selector modal
          showSpaceSelectorModal();
        } catch (error) {
          console.error('Error opening space selector:', error);
          showError('Failed to open space selector');
        }
      }

      async function showSpaceSelectorModal() {
        console.log('showSpaceSelectorModal called');
        let spaces;

        try {
          // Get available spaces
          spaces = await window.api.getSpaces();
          console.log('Spaces received:', spaces);

          if (!spaces || spaces.length === 0) {
            showError('No spaces available. Please create a space first.');
            return;
          }
        } catch (error) {
          console.error('Error getting spaces:', error);
          showError('Failed to load spaces: ' + error.message);
          return;
        }

        // Create modal HTML
        const modalHTML = `
                <div id="spaceSelectModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                ">
                    <div style="
                        background: #2d2d2d;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 500px;
                        max-height: 70vh;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    ">
                        <div style="
                            padding: 20px 30px;
                            border-bottom: 1px solid #3e3e3e;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h2 style="margin: 0; font-size: 20px; font-weight: 500;">Select Space</h2>
                            <button onclick="closeSpaceSelectModal()" style="
                                background: none;
                                border: none;
                                color: #e0e0e0;
                                font-size: 24px;
                                cursor: pointer;
                                padding: 0;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border-radius: 4px;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#3e3e3e'" onmouseout="this.style.background='none'">√ó</button>
                        </div>
                        
                        <div style="
                            flex: 1;
                            overflow-y: auto;
                            padding: 20px;
                        ">
                            <div style="margin-bottom: 15px; color: #888; font-size: 14px;">
                                Choose a space to save your generated document:
                            </div>
                            <div id="spaceList">
                                ${spaces
                                  .map((space) => {
                                    const escapedId = space.id.replace(/'/g, "\\'");
                                    const escapedName = space.name.replace(/'/g, "\\'");
                                    return `
                                        <div class="space-option" data-space-id="${space.id}" data-space-name="${space.name}" style="
                                            padding: 16px;
                                            margin: 8px 0;
                                            background: #3e3e3e;
                                            border-radius: 8px;
                                            cursor: pointer;
                                            display: flex;
                                            align-items: center;
                                            gap: 16px;
                                            transition: all 0.2s;
                                            border: 2px solid transparent;
                                        " onmouseover="this.style.background='#4e4e4e';this.style.borderColor='#0e639c'" 
                                           onmouseout="this.style.background='#3e3e3e';this.style.borderColor='transparent'">
                                            <span style="font-size: 28px;">${space.icon || 'üìÅ'}</span>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 500; font-size: 16px; margin-bottom: 4px;">${space.name}</div>
                                                <div style="font-size: 12px; color: #888;">${space.itemCount || 0} items</div>
                                            </div>
                                        </div>
                                    `;
                                  })
                                  .join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // Add click event listeners to space options
        document.querySelectorAll('.space-option').forEach((option) => {
          option.addEventListener('click', function () {
            const spaceId = this.dataset.spaceId;
            const spaceName = this.dataset.spaceName;
            selectSpaceAndSave(spaceId, spaceName);
          });
        });
      }

      function closeSpaceSelectModal() {
        const modal = document.getElementById('spaceSelectModal');
        if (modal) modal.remove();
      }

      async function selectSpaceAndSave(spaceId, spaceName) {
        console.log('selectSpaceAndSave called with:', spaceId, spaceName);
        try {
          closeSpaceSelectModal();
          updateStatus(`Saving to "${spaceName}"...`);

          const html = currentTab === 'source' ? document.getElementById('sourceCode').value : currentHTML;

          // Prepare the content to save
          const contentToSave = {
            type: 'generated-document',
            title: exportData?.metadata?.title || 'Generated Document',
            content: html,
            spaceId: spaceId,
            metadata: {
              ...exportData?.metadata,
              template: selectedTemplate?.id || 'basic',
              templateName: selectedTemplate?.name || 'Basic Export',
              generatedAt: new Date().toISOString(),
              isAIGenerated: isAIMode,
            },
          };

          console.log('Content to save:', contentToSave);

          // Save to the selected space
          const saved = await window.api.saveToSpace(contentToSave);
          console.log('Save result:', saved);

          if (saved) {
            updateStatus(`‚úì Saved to "${spaceName}" successfully`);

            // Store the space ID to switch to
            localStorage.setItem('pendingSwitchToSpace', spaceId);

            // Show success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #4caf50;
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                        z-index: 1001;
                        animation: slideIn 0.3s ease-out;
                    `;
            notification.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">‚úÖ</span>
                            <div>
                                <div style="font-weight: 600;">Saved to ${spaceName}</div>
                                <div style="font-size: 12px; opacity: 0.9;">Document added successfully</div>
                            </div>
                        </div>
                    `;
            document.body.appendChild(notification);

            // Remove notification after 3 seconds
            setTimeout(() => {
              notification.style.animation = 'slideOut 0.3s ease-in';
              setTimeout(() => notification.remove(), 300);
            }, 3000);
          }
        } catch (error) {
          console.error('Error saving to space:', error);
          showError('Failed to save to space');
        }
      }

      // Handle source code changes
      document.getElementById('sourceCode').addEventListener('input', (e) => {
        currentHTML = e.target.value;
        if (currentTab === 'source') {
          // Update preview in real-time
          updatePreview(currentHTML);
        }
      });

      // Make functions globally available
      window.closeSpaceSelectModal = closeSpaceSelectModal;
      window.selectSpaceAndSave = selectSpaceAndSave;

      // Handle Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          // Close any open modals
          const templateModal = document.getElementById('templateModal');
          const spaceModal = document.getElementById('spaceSelectModal');
          const styleModal = document.getElementById('styleFromURLModal');

          if (spaceModal) {
            closeSpaceSelectModal();
          } else if (templateModal) {
            closeTemplateModal();
          } else if (styleModal) {
            closeStyleFromURLModal();
          }
        }
      });

      // Style Guide Management
      let savedStyleGuides = {};

      // Load saved style guides
      async function loadStyleGuides() {
        try {
          const guides = await window.api.getStyleGuides();
          savedStyleGuides = guides || {};
          updateStyleGuideDropdown();
        } catch (error) {
          console.error('Error loading style guides:', error);
        }
      }

      // Update the dropdown with saved style guides
      function updateStyleGuideDropdown() {
        const dropdown = document.getElementById('styleGuideDropdown');

        // Find the position to insert saved guides (before the last option which is "Add New")
        const addNewOption = dropdown.lastElementChild;

        // Remove existing saved style guides (everything between separator and "Add New")
        while (dropdown.options[dropdown.options.length - 2].value !== '') {
          dropdown.remove(dropdown.options.length - 2);
        }

        // Add saved style guides before "Add New" option
        const styleGuideEntries = Object.entries(savedStyleGuides);
        styleGuideEntries.forEach(([id, guide]) => {
          const option = document.createElement('option');
          option.value = id;
          // Add icon based on type
          const icon = guide.type === 'generated' ? 'üåê' : 'üìù';
          option.textContent = `${icon} ${guide.name}`;
          dropdown.insertBefore(option, addNewOption);
        });

        // Update the default option text to show count if there are saved guides
        if (styleGuideEntries.length > 0) {
          dropdown.options[0].textContent = `üé® Select Style Guide (${styleGuideEntries.length} saved)`;
        } else {
          dropdown.options[0].textContent = 'üé® Select Style Guide';
        }
      }

      // Handle style guide selection
      function handleStyleGuideChange(value) {
        if (!value) return;

        if (value === 'add-new') {
          showAddStyleGuideModal();
        } else if (value === 'default') {
          // Default is journey map style - remove any custom styles to revert to it
          removeCustomStyles();
          updateStatus('Reverted to default Journey Map style');
        } else if (value === 'view-guide') {
          // Switch to the Style Guide tab
          showTab('styleguide');
          const styleGuideTab = document.querySelector('.tab:nth-child(3)');
          if (styleGuideTab) {
            styleGuideTab.click();
          }
        } else if (savedStyleGuides[value]) {
          // Show context menu for saved style guide
          showStyleGuideContextMenu(value, savedStyleGuides[value]);
        }

        // Reset dropdown to show default text
        document.getElementById('styleGuideDropdown').selectedIndex = 0;
      }

      function showStyleGuideContextMenu(id, guide) {
        // Create context menu
        const menuHTML = `
                <div id="styleGuideContextMenu" style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #2d2d2d;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
                    padding: 0;
                    z-index: 1000;
                    min-width: 250px;
                ">
                    <div style="
                        padding: 16px 20px;
                        border-bottom: 1px solid #3e3e3e;
                        font-weight: 600;
                        font-size: 16px;
                    ">
                        ${guide.type === 'generated' ? 'üåê' : 'üìù'} ${guide.name}
                    </div>
                    <div style="padding: 8px 0;">
                        <button onclick="applySelectedStyleGuide('${id}')" style="
                            display: block;
                            width: 100%;
                            padding: 12px 20px;
                            background: none;
                            border: none;
                            color: #e0e0e0;
                            text-align: left;
                            cursor: pointer;
                            font-size: 14px;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#3e3e3e'" onmouseout="this.style.background='none'">
                            ‚úì Apply to Export
                        </button>
                        <button onclick="viewSelectedStyleGuide('${id}')" style="
                            display: block;
                            width: 100%;
                            padding: 12px 20px;
                            background: none;
                            border: none;
                            color: #e0e0e0;
                            text-align: left;
                            cursor: pointer;
                            font-size: 14px;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#3e3e3e'" onmouseout="this.style.background='none'">
                            üëÅÔ∏è View/Edit CSS
                        </button>
                        <button onclick="previewSelectedStyleGuide('${id}')" style="
                            display: block;
                            width: 100%;
                            padding: 12px 20px;
                            background: none;
                            border: none;
                            color: #e0e0e0;
                            text-align: left;
                            cursor: pointer;
                            font-size: 14px;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#3e3e3e'" onmouseout="this.style.background='none'">
                            üìÑ View Style Guide
                        </button>
                        <button onclick="deleteSelectedStyleGuide('${id}')" style="
                            display: block;
                            width: 100%;
                            padding: 12px 20px;
                            background: none;
                            border: none;
                            color: #ff6b6b;
                            text-align: left;
                            cursor: pointer;
                            font-size: 14px;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#3e3e3e'" onmouseout="this.style.background='none'">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                    <div style="
                        padding: 12px 20px;
                        border-top: 1px solid #3e3e3e;
                        text-align: right;
                    ">
                        <button onclick="closeStyleGuideContextMenu()" style="
                            background: #666;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Cancel</button>
                    </div>
                </div>
                <div id="contextMenuOverlay" onclick="closeStyleGuideContextMenu()" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 999;
                "></div>
            `;

        document.body.insertAdjacentHTML('beforeend', menuHTML);
      }

      function closeStyleGuideContextMenu() {
        const menu = document.getElementById('styleGuideContextMenu');
        const overlay = document.getElementById('contextMenuOverlay');
        if (menu) menu.remove();
        if (overlay) overlay.remove();
      }

      function applySelectedStyleGuide(id) {
        closeStyleGuideContextMenu();
        if (savedStyleGuides[id]) {
          applyStyleGuide(savedStyleGuides[id]);
        }
      }

      async function deleteSelectedStyleGuide(id) {
        if (confirm('Are you sure you want to delete this style guide?')) {
          try {
            await window.api.deleteStyleGuide(id);
            delete savedStyleGuides[id];
            updateStyleGuideDropdown();
            updateStatus('Style guide deleted');
            closeStyleGuideContextMenu();
          } catch (error) {
            console.error('Error deleting style guide:', error);
            showError('Failed to delete style guide');
          }
        }
      }

      function viewSelectedStyleGuide(id) {
        closeStyleGuideContextMenu();
        const guide = savedStyleGuides[id];
        if (!guide) return;

        // Show the CSS in a modal for viewing/editing
        showStyleGuideViewModal(guide);
      }

      function showStyleGuideViewModal(guide) {
        const modalHTML = `
                <div id="viewStyleGuideModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                ">
                    <div style="
                        background: #2d2d2d;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 800px;
                        max-height: 85vh;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    ">
                        <div style="
                            padding: 20px 30px;
                            border-bottom: 1px solid #3e3e3e;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h2 style="margin: 0; font-size: 20px; font-weight: 500;">
                                ${guide.type === 'generated' ? 'üåê' : 'üìù'} ${guide.name}
                            </h2>
                            <button onclick="closeViewStyleGuideModal()" style="
                                background: none;
                                border: none;
                                color: #e0e0e0;
                                font-size: 24px;
                                cursor: pointer;
                                padding: 0;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border-radius: 4px;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#3e3e3e'" onmouseout="this.style.background='none'">√ó</button>
                        </div>
                        
                        <div style="
                            padding: 20px 30px;
                            border-bottom: 1px solid #3e3e3e;
                            font-size: 14px;
                            color: #888;
                        ">
                            ${
                              guide.type === 'generated'
                                ? `Generated from: ${guide.urls ? guide.urls.join(', ') : 'URLs'}`
                                : 'Manually created style guide'
                            }<br>
                            Created: ${new Date(guide.createdAt).toLocaleDateString()}
                        </div>
                        
                        <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                            <div style="
                                padding: 10px 30px;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            ">
                                <h3 style="margin: 0; font-size: 16px;">CSS Styles</h3>
                                <button id="editCSSBtn" onclick="toggleEditMode('${guide.id}')" style="
                                    background: #0e639c;
                                    color: white;
                                    border: none;
                                    padding: 6px 16px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">‚úèÔ∏è Edit</button>
                            </div>
                            
                            <div style="flex: 1; overflow: auto; padding: 0 30px 20px 30px;">
                                <pre id="viewCSS" style="
                                    background: #1e1e1e;
                                    padding: 20px;
                                    border-radius: 8px;
                                    overflow: auto;
                                    font-family: 'Monaco', 'Menlo', monospace;
                                    font-size: 13px;
                                    line-height: 1.5;
                                    color: #e0e0e0;
                                    margin: 0;
                                ">${escapeHtml(guide.css)}</pre>
                                
                                <textarea id="editCSS" style="
                                    display: none;
                                    width: 100%;
                                    height: 100%;
                                    background: #1e1e1e;
                                    padding: 20px;
                                    border-radius: 8px;
                                    font-family: 'Monaco', 'Menlo', monospace;
                                    font-size: 13px;
                                    line-height: 1.5;
                                    color: #e0e0e0;
                                    border: 1px solid #3e3e3e;
                                    resize: none;
                                ">${guide.css}</textarea>
                            </div>
                        </div>
                        
                        <div style="
                            padding: 20px 30px;
                            border-top: 1px solid #3e3e3e;
                            display: flex;
                            gap: 10px;
                            justify-content: space-between;
                        ">
                            <button onclick="applySelectedStyleGuide('${guide.id}')" style="
                                background: #10b981;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                            ">‚úì Apply to Export</button>
                            
                            <div style="display: flex; gap: 10px;">
                                <button id="saveChangesBtn" onclick="saveStyleGuideChanges('${guide.id}')" style="
                                    display: none;
                                    background: #4caf50;
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">üíæ Save Changes</button>
                                
                                <button class="btn-secondary" onclick="closeViewStyleGuideModal()">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function closeViewStyleGuideModal() {
        const modal = document.getElementById('viewStyleGuideModal');
        if (modal) modal.remove();
      }

      function toggleEditMode(id) {
        const viewCSS = document.getElementById('viewCSS');
        const editCSS = document.getElementById('editCSS');
        const editBtn = document.getElementById('editCSSBtn');
        const saveBtn = document.getElementById('saveChangesBtn');

        if (editCSS.style.display === 'none') {
          // Switch to edit mode
          viewCSS.style.display = 'none';
          editCSS.style.display = 'block';
          editBtn.textContent = 'üëÅÔ∏è View';
          editBtn.style.background = '#666';
          saveBtn.style.display = 'block';
          editCSS.focus();
        } else {
          // Switch to view mode
          editCSS.style.display = 'none';
          viewCSS.style.display = 'block';
          editBtn.textContent = '‚úèÔ∏è Edit';
          editBtn.style.background = '#0e639c';
          saveBtn.style.display = 'none';

          // Update preview with edited content
          viewCSS.textContent = editCSS.value;
        }
      }

      async function saveStyleGuideChanges(id) {
        const editCSS = document.getElementById('editCSS');
        const guide = savedStyleGuides[id];

        if (!guide) return;

        // Update the guide with new CSS
        guide.css = editCSS.value;
        guide.updatedAt = new Date().toISOString();

        try {
          await window.api.saveStyleGuide(guide);
          savedStyleGuides[id] = guide;
          updateStatus('Style guide updated successfully');

          // Switch back to view mode
          toggleEditMode(id);
        } catch (error) {
          console.error('Error saving style guide:', error);
          showError('Failed to save changes');
        }
      }

      function removeCustomStyles() {
        // Remove any custom style tags
        const customStyles = document.querySelectorAll('style[id^="custom-"]');
        customStyles.forEach((style) => style.remove());

        // Update the preview
        const iframe = document.getElementById('previewFrame');
        if (iframe && iframe.contentDocument) {
          const iframeCustomStyles = iframe.contentDocument.querySelectorAll('style[id^="custom-"]');
          iframeCustomStyles.forEach((style) => style.remove());
        }

        // Revert to default style guide display
        loadDefaultStyleGuide();
      }

      function applyStyleGuide(guide) {
        if (guide.css) {
          applyCustomStyles(guide.css);
          updateStyleGuideDisplay(guide.name, guide.css);
          updateStatus(`Applied "${guide.name}" style guide`);
        }
      }

      // Show modal to add new style guide
      function showAddStyleGuideModal() {
        const modalHTML = `
                <div id="addStyleGuideModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                ">
                    <div style="
                        background: #2d2d2d;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 700px;
                        max-height: 85vh;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    ">
                        <div style="
                            padding: 20px 30px;
                            border-bottom: 1px solid #3e3e3e;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h2 style="margin: 0; font-size: 20px; font-weight: 500;">Add New Style Guide</h2>
                            <button onclick="closeAddStyleGuideModal()" style="
                                background: none;
                                border: none;
                                color: #e0e0e0;
                                font-size: 24px;
                                cursor: pointer;
                                padding: 0;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border-radius: 4px;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#3e3e3e'" onmouseout="this.style.background='none'">√ó</button>
                        </div>
                        
                        <div style="padding: 20px 30px 0 30px;">
                            <input type="text" 
                                   id="newStyleGuideName" 
                                   placeholder="Style guide name (e.g., 'Corporate Blue')" 
                                   style="
                                       width: 100%;
                                       padding: 12px;
                                       background: #1e1e1e;
                                       border: 1px solid #3e3e3e;
                                       border-radius: 6px;
                                       color: #e0e0e0;
                                       font-size: 14px;
                                       margin-bottom: 20px;
                                   ">
                            
                            <div style="
                                display: flex;
                                gap: 10px;
                                margin-bottom: 20px;
                                border-bottom: 1px solid #3e3e3e;
                            ">
                                <button id="tabPasteCSS" 
                                        onclick="switchStyleTab('paste')" 
                                        class="style-tab active" 
                                        style="
                                            padding: 10px 20px;
                                            background: none;
                                            border: none;
                                            border-bottom: 2px solid #0e639c;
                                            color: #e0e0e0;
                                            cursor: pointer;
                                            font-size: 14px;
                                            transition: all 0.2s;
                                        ">
                                    üìã Paste CSS
                                </button>
                                <button id="tabGenerateFromURL" 
                                        onclick="switchStyleTab('generate')" 
                                        class="style-tab" 
                                        style="
                                            padding: 10px 20px;
                                            background: none;
                                            border: none;
                                            border-bottom: 2px solid transparent;
                                            color: #888;
                                            cursor: pointer;
                                            font-size: 14px;
                                            transition: all 0.2s;
                                        ">
                                    ü§ñ AI Extract from URLs
                                </button>
                            </div>
                        </div>
                        
                        <div style="flex: 1; overflow-y: auto; padding: 0 30px 20px 30px;">
                            <!-- Paste CSS Tab -->
                            <div id="pasteTab" style="display: block;">
                                <p style="color: #e0e0e0; margin-bottom: 10px; font-size: 14px;">
                                    Paste your CSS code below. Use CSS variables for flexibility:
                                </p>
                                <textarea id="pastedCSS" 
                                          placeholder=":root {
  --color-primary: #3b82f6;
  --color-secondary: #10b981;
  --font-heading: 'Georgia, serif';
  --font-body: 'Arial, sans-serif';
}

/* Your custom styles here... */" 
                                          style="
                                              width: 100%;
                                              height: 300px;
                                              padding: 12px;
                                              background: #1e1e1e;
                                              border: 1px solid #3e3e3e;
                                              border-radius: 6px;
                                              color: #e0e0e0;
                                              font-family: 'Monaco', 'Menlo', monospace;
                                              font-size: 13px;
                                              resize: vertical;
                                          "></textarea>
                            </div>
                            
                            <!-- Generate from URL Tab -->
                            <div id="generateTab" style="display: none;">
                                <p style="color: #e0e0e0; margin-bottom: 10px; font-size: 14px;">
                                    Enter one or more website URLs to analyze and extract styles:
                                </p>
                            
                            <div id="urlInputContainer">
                                <div class="url-input-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <input type="text" 
                                           placeholder="example.com or https://example.com" 
                                           style="
                                               flex: 1;
                                               padding: 10px;
                                               background: #1e1e1e;
                                               border: 1px solid #3e3e3e;
                                               border-radius: 6px;
                                               color: #e0e0e0;
                                               font-size: 14px;
                                           " 
                                           class="url-input">
                                    <button onclick="removeURLInput(this)" class="btn-secondary" style="padding: 10px 15px;">√ó</button>
                                </div>
                            </div>
                            
                            <button onclick="addURLInput()" class="btn-secondary" style="margin-bottom: 20px;">
                                + Add Another URL
                            </button>
                            
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #3e3e3e;">
                                <h3 style="font-size: 16px; margin-bottom: 10px;">Style Options</h3>
                                
                                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="extractColors" checked style="margin-right: 10px;">
                                    <span>Extract color palette</span>
                                </label>
                                
                                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="extractFonts" checked style="margin-right: 10px;">
                                    <span>Extract typography</span>
                                </label>
                                
                                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="extractSpacing" checked style="margin-right: 10px;">
                                    <span>Extract spacing system</span>
                                </label>
                                
                                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                                    <input type="checkbox" id="extractComponents" checked style="margin-right: 10px;">
                                    <span>Extract component styles</span>
                                </label>
                                
                                <div style="
                                    margin-top: 15px;
                                    padding: 12px;
                                    background: #1a2f1a;
                                    border: 1px solid #2d542d;
                                    border-radius: 6px;
                                    font-size: 13px;
                                    color: #a8d5a8;
                                ">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px;">ü§ñ</span>
                                        <span>AI Enhancement Enabled</span>
                                    </div>
                                    <div style="margin-top: 5px; font-size: 12px; color: #e0e0e0;">
                                        Claude will automatically review and enhance the extracted styles to ensure a complete, professional style guide.
                                    </div>
                                </div>
                            </div>
                            
                            <div id="styleAnalysisResult" style="
                                display: none;
                                margin-top: 20px;
                                padding: 20px;
                                background: #1e1e1e;
                                border-radius: 8px;
                                border: 1px solid #3e3e3e;
                            ">
                                <h3 style="font-size: 16px; margin-bottom: 10px;">Analysis Result</h3>
                                <div id="analysisContent"></div>
                                
                                <!-- Add CSS Preview Section -->
                                <div id="generatedCSSPreview" style="
                                    display: none;
                                    margin-top: 20px;
                                    padding-top: 20px;
                                    border-top: 1px solid #3e3e3e;
                                ">
                                    <h4 style="font-size: 14px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                        <span>Generated CSS</span>
                                        <button onclick="editGeneratedCSS()" style="
                                            background: #0e639c;
                                            color: white;
                                            border: none;
                                            padding: 4px 12px;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-size: 12px;
                                        ">‚úèÔ∏è Edit</button>
                                    </h4>
                                    <pre id="cssPreview" style="
                                        background: #0d0d0d;
                                        padding: 12px;
                                        border-radius: 4px;
                                        overflow: auto;
                                        max-height: 200px;
                                        font-family: 'Monaco', 'Menlo', monospace;
                                        font-size: 12px;
                                        line-height: 1.4;
                                        color: #e0e0e0;
                                        margin: 0;
                                    "></pre>
                                    <textarea id="cssEditBox" style="
                                        display: none;
                                        width: 100%;
                                        height: 200px;
                                        background: #0d0d0d;
                                        padding: 12px;
                                        border-radius: 4px;
                                        font-family: 'Monaco', 'Menlo', monospace;
                                        font-size: 12px;
                                        line-height: 1.4;
                                        color: #e0e0e0;
                                        border: 1px solid #3e3e3e;
                                        resize: vertical;
                                    "></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div style="
                            padding: 20px 30px;
                            border-top: 1px solid #3e3e3e;
                            display: flex;
                            gap: 10px;
                            justify-content: flex-end;
                        ">
                            <button class="btn-secondary" onclick="closeAddStyleGuideModal()">Cancel</button>
                            <button class="btn-primary" id="saveStyleGuideBtn" onclick="saveNewStyleGuide()">Save Style Guide</button>
                        </div>
                    </div>
                </div>
            `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }

      function closeAddStyleGuideModal() {
        const modal = document.getElementById('addStyleGuideModal');
        if (modal) modal.remove();
      }

      function switchStyleTab(tab) {
        // Update tab buttons
        const pasteTab = document.getElementById('tabPasteCSS');
        const generateTab = document.getElementById('tabGenerateFromURL');
        const pasteContent = document.getElementById('pasteTab');
        const generateContent = document.getElementById('generateTab');

        if (tab === 'paste') {
          pasteTab.style.borderBottomColor = '#0e639c';
          pasteTab.style.color = '#e0e0e0';
          generateTab.style.borderBottomColor = 'transparent';
          generateTab.style.color = '#888';
          pasteContent.style.display = 'block';
          generateContent.style.display = 'none';
          document.getElementById('saveStyleGuideBtn').textContent = 'Save Style Guide';
        } else {
          generateTab.style.borderBottomColor = '#0e639c';
          generateTab.style.color = '#e0e0e0';
          pasteTab.style.borderBottomColor = 'transparent';
          pasteTab.style.color = '#888';
          generateContent.style.display = 'block';
          pasteContent.style.display = 'none';
          document.getElementById('saveStyleGuideBtn').textContent = 'Analyze & Save';
        }
      }

      async function saveNewStyleGuide() {
        console.log('saveNewStyleGuide called');

        const nameInput = document.getElementById('newStyleGuideName');
        if (!nameInput) {
          console.error('Style guide name input not found');
          showError('Style guide name input not found');
          return;
        }

        const name = nameInput.value.trim();
        if (!name) {
          showError('Please enter a name for the style guide');
          return;
        }

        const activeTab = document.getElementById('pasteTab').style.display === 'block' ? 'paste' : 'generate';
        console.log('Active tab:', activeTab);

        if (activeTab === 'paste') {
          // Save pasted CSS
          const css = document.getElementById('pastedCSS').value.trim();
          if (!css) {
            showError('Please paste some CSS code');
            return;
          }

          const styleGuide = {
            id: `custom-${Date.now()}`,
            name: name,
            css: css,
            type: 'custom',
            createdAt: new Date().toISOString(),
          };

          await saveStyleGuide(styleGuide);
          applyStyleGuide(styleGuide);
          closeAddStyleGuideModal();
        } else {
          // Generate from URLs
          console.log('Generating from URLs...');
          await analyzeURLStyles(true);
        }
      }

      async function saveStyleGuide(guide) {
        try {
          await window.api.saveStyleGuide(guide);
          savedStyleGuides[guide.id] = guide;
          updateStyleGuideDropdown();
          updateStatus(`Style guide "${guide.name}" saved successfully`);
        } catch (error) {
          console.error('Error saving style guide:', error);
          showError('Failed to save style guide');
        }
      }

      function addURLInput() {
        const container = document.getElementById('urlInputContainer');
        const newInput = document.createElement('div');
        newInput.className = 'url-input-row';
        newInput.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
        newInput.innerHTML = `
                <input type="text" 
                       placeholder="example.com or https://example.com" 
                       style="
                           flex: 1;
                           padding: 10px;
                           background: #1e1e1e;
                           border: 1px solid #3e3e3e;
                           border-radius: 6px;
                           color: #e0e0e0;
                           font-size: 14px;
                       " 
                       class="url-input">
                <button onclick="removeURLInput(this)" class="btn-secondary" style="padding: 10px 15px;">√ó</button>
            `;
        container.appendChild(newInput);
      }

      function removeURLInput(button) {
        const container = document.getElementById('urlInputContainer');
        if (container.children.length > 1) {
          button.parentElement.remove();
        }
      }

      async function analyzeURLStyles(saveAfter = false) {
        const urls = Array.from(document.querySelectorAll('.url-input'))
          .map((input) => {
            let url = input.value.trim();
            if (url && !url.match(/^https?:\/\//i)) {
              url = 'https://' + url;
            }
            return url;
          })
          .filter((url) => url && isValidURL(url));

        if (urls.length === 0) {
          showError('Please enter at least one valid URL');
          return;
        }

        console.log('Analyzing URLs:', urls);

        const options = {
          extractColors: document.getElementById('extractColors').checked,
          extractFonts: document.getElementById('extractFonts').checked,
          extractSpacing: document.getElementById('extractSpacing').checked,
          extractComponents: document.getElementById('extractComponents').checked,
        };

        try {
          updateStatus('Analyzing website styles...');
          showLoading(true);

          // Show analyzing message in the modal
          const analysisResult = document.getElementById('styleAnalysisResult');
          const analysisContent = document.getElementById('analysisContent');
          analysisResult.style.display = 'block';
          analysisContent.innerHTML =
            '<div style="text-align: center; padding: 20px;"><div class="spinner" style="margin: 0 auto;"></div><div style="margin-top: 10px;">Analyzing website styles...</div></div>';

          // Update loading steps for style analysis
          setTimeout(() => {
            updateLoadingStep('analyzing', true);
            updateLoaderStatus(`Visiting ${urls.length} website${urls.length > 1 ? 's' : ''}...`);
          }, 300);

          setTimeout(() => {
            updateLoadingStep('analyzing', false, true);
            updateLoadingStep('preparing', true);
            updateLoaderStatus('Extracting color palettes and typography...');
          }, 1500);

          // AI enhancement happens automatically
          setTimeout(() => {
            updateLoadingStep('preparing', false, true);
            updateLoadingStep('ai', true);
            updateLoaderStatus('Claude AI is enhancing the style guide...');
          }, 3000);

          // Call the API to analyze styles
          const result = await window.api.invoke('smart-export:extract-styles', urls, options);
          console.log('Analysis result:', result);

          if (result.success) {
            // Complete the loading steps
            updateLoadingStep('ai', false, true);
            updateLoadingStep('formatting', true);
            updateLoaderStatus('Generating CSS from enhanced style guide...');

            displayStyleAnalysis(result.styles);

            // Store the analysis result for later use
            window.lastAnalysisResult = result;

            // Generate CSS from the analysis
            const generatedCSS = generateCSSFromAnalysis(result.styles);

            // Complete formatting step
            setTimeout(() => {
              updateLoadingStep('formatting', false, true);
              updateProgressBar(100);
              updateLoaderStatus('Style guide ready!');
            }, 500);

            if (saveAfter) {
              // Save as a new style guide
              const nameInput = document.getElementById('newStyleGuideName');
              if (!nameInput) {
                console.error('Style guide name input not found');
                showError('Style guide name input not found');
                return;
              }

              const name = nameInput.value.trim();
              if (!name) {
                showError('Please enter a name for the style guide');
                return;
              }

              // Use the edited CSS if available, otherwise use the generated CSS
              const finalCSS = window.lastGeneratedCSS || generatedCSS;

              const styleGuide = {
                id: `generated-${Date.now()}`,
                name: name,
                css: finalCSS,
                type: 'generated',
                urls: urls,
                llmEnhanced: result.llmEnhanced || false,
                analysisDetails: result.styles,
                createdAt: new Date().toISOString(),
              };

              await saveStyleGuide(styleGuide);
              applyStyleGuide(styleGuide);
              closeAddStyleGuideModal();
            } else {
              // Apply the styles to current export
              if (confirm('Would you like to apply these styles to your current export?')) {
                applyCustomStyles(generatedCSS, 'Generated Style (Unsaved)');
              }
            }
          } else {
            showError(result.error || 'Failed to analyze website styles');
            // Show error in the modal
            const analysisContent = document.getElementById('analysisContent');
            analysisContent.innerHTML = `<div style="color: #ff6b6b; text-align: center; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div>Failed to analyze website styles</div>
                        <div style="font-size: 12px; margin-top: 5px; color: #888;">${result.error || 'Unknown error'}</div>
                    </div>`;
          }
        } catch (error) {
          console.error('Error analyzing styles:', error);
          showError('Failed to analyze website styles: ' + error.message);
          // Show error in the modal
          const analysisContent = document.getElementById('analysisContent');
          if (analysisContent) {
            analysisContent.innerHTML = `<div style="color: #ff6b6b; text-align: center; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div>Failed to analyze website styles</div>
                        <div style="font-size: 12px; margin-top: 5px; color: #888;">${error.message}</div>
                    </div>`;
          }
        } finally {
          showLoading(false);
          updateStatus('Ready');
        }
      }

      function isValidURL(string) {
        try {
          // If the string doesn't have a protocol, add https://
          let urlString = string;
          if (!urlString.match(/^https?:\/\//i)) {
            urlString = 'https://' + urlString;
          }
          new URL(urlString);
          return true;
        } catch (_) {
          return false;
        }
      }

      function displayStyleAnalysis(styles) {
        const resultDiv = document.getElementById('styleAnalysisResult');
        const contentDiv = document.getElementById('analysisContent');

        let html = '';

        // Show AI enhancement status if available
        if (styles.metadata && styles.metadata.enhanced) {
          html += '<div style="';
          html += 'margin-bottom: 20px; padding: 15px; ';
          html += 'background: #1a2f1a; border: 1px solid #2d542d; ';
          html += 'border-radius: 8px;">';
          html += '<h4 style="font-size: 14px; margin-bottom: 10px; color: #4caf50;">‚ú® AI Enhanced</h4>';
          html +=
            '<div style="font-size: 13px; color: #e0e0e0;">Claude has reviewed and enhanced this style guide to ensure completeness and professional quality.</div>';

          if (styles.enhancements && styles.enhancements.description) {
            html += `<div style="font-size: 12px; color: #a8d5a8; margin-top: 8px;">Improvements: ${styles.enhancements.description}</div>`;
          }

          html += '</div>';
        }

        if (styles.colors && styles.colors.length > 0) {
          html += '<div style="margin-bottom: 20px;">';
          html += '<h4 style="font-size: 14px; margin-bottom: 10px;">Color Palette</h4>';
          html += '<div style="display: flex; gap: 10px; flex-wrap: wrap;">';
          styles.colors.forEach((color) => {
            const isLLMCorrected = color.llmCorrected || false;
            html += `
                        <div style="text-align: center; position: relative;">
                            <div style="
                                width: 60px;
                                height: 60px;
                                background: ${color.hex};
                                border-radius: 8px;
                                border: 1px solid ${isLLMCorrected ? '#4caf50' : '#3e3e3e'};
                                margin-bottom: 5px;
                                position: relative;
                            ">
                                ${isLLMCorrected ? '<div style="position: absolute; top: -8px; right: -8px; background: #4caf50; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">‚úì</div>' : ''}
                            </div>
                            <div style="font-size: 12px; color: #888;">${color.hex}</div>
                            ${color.category ? `<div style="font-size: 11px; color: #666;">${color.category}</div>` : ''}
                            ${isLLMCorrected && color.correctionReason ? `<div style="font-size: 10px; color: #4caf50; max-width: 80px; margin: 0 auto;" title="${color.correctionReason}">AI adjusted</div>` : ''}
                        </div>
                    `;
          });
          html += '</div></div>';
        }

        if (styles.fonts && styles.fonts.length > 0) {
          html += '<div style="margin-bottom: 20px;">';
          html += '<h4 style="font-size: 14px; margin-bottom: 10px;">Typography</h4>';
          styles.fonts.forEach((font) => {
            html += `
                        <div style="
                            padding: 10px;
                            background: #1e1e1e;
                            border-radius: 6px;
                            margin-bottom: 10px;
                            font-family: ${font.family};
                        ">
                            <div style="font-size: 18px; margin-bottom: 5px;">${font.family}</div>
                            <div style="font-size: 12px; color: #888;">
                                Sizes: ${font.sizes.join(', ')} | 
                                Weights: ${font.weights.join(', ')}
                            </div>
                        </div>
                    `;
          });
          html += '</div>';
        }

        contentDiv.innerHTML = html;
        resultDiv.style.display = 'block';

        // Show the generated CSS
        const generatedCSS = generateCSSFromAnalysis(styles);
        const cssPreviewDiv = document.getElementById('generatedCSSPreview');
        const cssPreview = document.getElementById('cssPreview');
        const cssEditBox = document.getElementById('cssEditBox');

        cssPreview.textContent = generatedCSS;
        cssEditBox.value = generatedCSS;
        cssPreviewDiv.style.display = 'block';

        // Store the generated CSS for later use
        window.lastGeneratedCSS = generatedCSS;
      }

      function generateCSSFromAnalysis(styles) {
        let css = '/* AI-Enhanced Style Guide */\n\n';

        // CSS Variables
        css += ':root {\n';

        // Colors - Handle enhanced structure
        if (styles.colors && styles.colors.length > 0) {
          css += '  /* Colors */\n';

          // Enhanced styles have categorized colors with more info
          styles.colors.forEach((color) => {
            if (color.category) {
              const varName = `--color-${color.category}`;
              css += `  ${varName}: ${color.hex}; /* ${color.name || color.category} */\n`;

              // Add usage comments if available
              if (color.usage) {
                css += `  /* Usage: ${color.usage} */\n`;
              }
            } else {
              // Fallback for old structure
              const categoryMap = ['primary', 'secondary', 'text', 'background', 'accent'];
              const index = styles.colors.indexOf(color);
              if (index < categoryMap.length) {
                css += `  --color-${categoryMap[index]}: ${color.hex};\n`;
              }
            }
          });
        }

        // Fonts - Handle enhanced structure
        if (styles.fonts && styles.fonts.length > 0) {
          css += '\n  /* Typography */\n';

          const primaryFont = styles.fonts[0];
          if (primaryFont) {
            // Add font families
            css += `  --font-heading: ${primaryFont.family}${primaryFont.fallback ? ', ' + primaryFont.fallback : ''};\n`;
            css += `  --font-body: ${styles.fonts[1]?.family || primaryFont.family}${styles.fonts[1]?.fallback ? ', ' + styles.fonts[1].fallback : primaryFont.fallback ? ', ' + primaryFont.fallback : ''};\n`;

            // Add font sizes if provided
            if (primaryFont.sizes) {
              css += '\n  /* Font Sizes */\n';
              Object.entries(primaryFont.sizes).forEach(([key, value]) => {
                css += `  --font-size-${key}: ${value};\n`;
              });
            } else {
              // Default sizes
              css += '\n  /* Font Sizes */\n';
              css += '  --font-size-xs: 0.75rem;\n';
              css += '  --font-size-sm: 0.875rem;\n';
              css += '  --font-size-base: 1rem;\n';
              css += '  --font-size-lg: 1.125rem;\n';
              css += '  --font-size-xl: 1.5rem;\n';
              css += '  --font-size-2xl: 2rem;\n';
              css += '  --font-size-3xl: 3rem;\n';
            }

            // Add font weights if provided
            if (primaryFont.weights) {
              css += '\n  /* Font Weights */\n';
              Object.entries(primaryFont.weights).forEach(([key, value]) => {
                css += `  --font-weight-${key}: ${value};\n`;
              });
            }

            // Add line heights if provided
            if (primaryFont.lineHeights) {
              css += '\n  /* Line Heights */\n';
              Object.entries(primaryFont.lineHeights).forEach(([key, value]) => {
                css += `  --line-height-${key}: ${value};\n`;
              });
            }
          }
        }

        // Spacing
        if (styles.spacing) {
          css += '\n  /* Spacing */\n';
          Object.entries(styles.spacing).forEach(([key, value]) => {
            css += `  --spacing-${key}: ${value};\n`;
          });
        } else {
          // Default spacing
          css += '\n  /* Default Spacing */\n';
          css += '  --spacing-xs: 0.25rem;\n';
          css += '  --spacing-sm: 0.5rem;\n';
          css += '  --spacing-md: 1rem;\n';
          css += '  --spacing-lg: 2rem;\n';
          css += '  --spacing-xl: 3rem;\n';
          css += '  --spacing-xxl: 4rem;\n';
        }

        // Border Radius (from enhanced structure)
        if (styles.borderRadius) {
          css += '\n  /* Border Radius */\n';
          Object.entries(styles.borderRadius).forEach(([key, value]) => {
            css += `  --radius-${key}: ${value};\n`;
          });
        }

        // Shadows (from enhanced structure)
        if (styles.shadows) {
          css += '\n  /* Shadows */\n';
          Object.entries(styles.shadows).forEach(([key, value]) => {
            css += `  --shadow-${key}: ${value};\n`;
          });
        }

        css += '}\n\n';

        // Document styles
        css += '/* Document Styles */\n';
        css += '.smart-export-document {\n';
        css += '  font-family: var(--font-body);\n';
        css += '  color: var(--color-text, #2C2C2C);\n';
        css += '  line-height: 1.6;\n';
        css += '}\n\n';

        css += '/* Typography */\n';
        css += 'h1, h2, h3, h4, h5, h6 {\n';
        css += '  font-family: var(--font-heading);\n';
        css += '  font-weight: var(--font-weight-semibold, 600);\n';
        css += '  line-height: var(--line-height-tight, 1.2);\n';
        css += '  margin-bottom: var(--spacing-md);\n';
        css += '  color: var(--color-text);\n';
        css += '}\n\n';

        css += 'h1 { font-size: var(--font-size-3xl, 3rem); font-weight: var(--font-weight-bold, 700); }\n';
        css += 'h2 { font-size: var(--font-size-2xl, 2rem); }\n';
        css += 'h3 { font-size: var(--font-size-xl, 1.5rem); }\n';
        css += 'h4 { font-size: var(--font-size-lg, 1.125rem); }\n\n';

        css += 'p {\n';
        css += '  margin-bottom: var(--spacing-md);\n';
        css += '}\n\n';

        // Component styles - Handle enhanced structure with variants
        if (styles.components) {
          css += '/* Component Styles */\n';
          Object.entries(styles.components).forEach(([component, rules]) => {
            if (rules && Object.keys(rules).length > 0) {
              // Base component styles
              css += `.${component} {\n`;
              Object.entries(rules).forEach(([property, value]) => {
                if (property !== 'variants' && value && value !== 'undefined') {
                  // Replace color references with CSS variables
                  if (property.includes('color') || property.includes('Color')) {
                    if (value.includes('primary')) {
                      value = 'var(--color-primary)';
                    } else if (value.includes('secondary')) {
                      value = 'var(--color-secondary)';
                    } else if (value.includes('white')) {
                      value = '#ffffff';
                    }
                  }
                  css += `  ${property.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value};\n`;
                }
              });
              css += '}\n\n';

              // Component variants
              if (rules.variants) {
                Object.entries(rules.variants).forEach(([variantName, variantStyles]) => {
                  css += `.${component}.${variantName}, .${component}--${variantName} {\n`;
                  Object.entries(variantStyles).forEach(([property, value]) => {
                    if (value && value !== 'undefined') {
                      css += `  ${property.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${value};\n`;
                    }
                  });
                  css += '}\n\n';
                });
              }
            }
          });
        }

        // Additional useful styles with enhanced variables
        css += '/* Cards and Containers */\n';
        css += '.content-card {\n';
        css += '  background: var(--color-background, white);\n';
        css += '  border: 1px solid var(--color-border, var(--color-secondary, #e0e0e0));\n';
        css += '  border-radius: var(--radius-lg, 8px);\n';
        css += '  padding: var(--spacing-lg);\n';
        css += '  margin-bottom: var(--spacing-lg);\n';
        css += '  box-shadow: var(--shadow-base, none);\n';
        css += '}\n\n';

        css += '/* Lists */\n';
        css += '.styled-list {\n';
        css += '  list-style: none;\n';
        css += '  padding-left: 0;\n';
        css += '}\n\n';
        css += '.styled-list li {\n';
        css += '  position: relative;\n';
        css += '  padding-left: var(--spacing-lg);\n';
        css += '  margin-bottom: var(--spacing-sm);\n';
        css += '}\n\n';
        css += '.styled-list li::before {\n';
        css += '  content: "‚Ä¢";\n';
        css += '  position: absolute;\n';
        css += '  left: 0;\n';
        css += '  color: var(--color-primary);\n';
        css += '}\n\n';

        css += '/* Utility Classes */\n';
        css += '.text-center { text-align: center; }\n';
        css += '.text-right { text-align: right; }\n';
        css += '.mb-sm { margin-bottom: var(--spacing-sm); }\n';
        css += '.mb-md { margin-bottom: var(--spacing-md); }\n';
        css += '.mb-lg { margin-bottom: var(--spacing-lg); }\n';

        return css;
      }

      function applyCustomStyles(css, styleName = 'Custom Style') {
        // Update the current HTML with the new styles
        const styleTag = `<style id="custom-style-guide">\n${css}\n</style>`;

        // If we're in source view, update the textarea
        if (currentTab === 'source') {
          const sourceCode = document.getElementById('sourceCode');
          let html = sourceCode.value;

          // Remove existing custom styles if present
          html = html.replace(/<style id="custom-[^"]+">[\s\S]*?<\/style>/g, '');

          // Add new styles before closing head tag
          html = html.replace('</head>', styleTag + '\n</head>');

          sourceCode.value = html;
          currentHTML = html;
        } else {
          // Update the preview directly
          currentHTML = currentHTML.replace(/<style id="custom-[^"]+">[\s\S]*?<\/style>/g, '');
          currentHTML = currentHTML.replace('</head>', styleTag + '\n</head>');
        }

        updatePreview(currentHTML);

        // Update style guide display if not called from applyStyleGuide
        if (!styleName.includes('(') && !styleName.includes(')')) {
          updateStyleGuideDisplay(styleName, css);
        }
      }

      function editGeneratedCSS() {
        const preview = document.getElementById('cssPreview');
        const editBox = document.getElementById('cssEditBox');
        const editButton = event.target;

        if (editBox.style.display === 'none') {
          // Switch to edit mode
          preview.style.display = 'none';
          editBox.style.display = 'block';
          editButton.textContent = '‚úì Done';
          editButton.style.background = '#4caf50';
          editBox.focus();
        } else {
          // Switch back to preview mode
          editBox.style.display = 'none';
          preview.style.display = 'block';
          editButton.textContent = '‚úèÔ∏è Edit';
          editButton.style.background = '#0e639c';

          // Update the preview with edited content
          preview.textContent = editBox.value;
          window.lastGeneratedCSS = editBox.value;
        }
      }

      // Make functions globally available
      window.showTab = showTab;
      window.closeAddStyleGuideModal = closeAddStyleGuideModal;
      window.addURLInput = addURLInput;
      window.removeURLInput = removeURLInput;
      window.analyzeURLStyles = analyzeURLStyles;
      window.showAddStyleGuideModal = showAddStyleGuideModal;
      window.handleStyleGuideChange = handleStyleGuideChange;
      window.switchStyleTab = switchStyleTab;
      window.saveNewStyleGuide = saveNewStyleGuide;
      window.editGeneratedCSS = editGeneratedCSS;
      window.closeStyleGuideContextMenu = closeStyleGuideContextMenu;
      window.applySelectedStyleGuide = applySelectedStyleGuide;
      window.deleteSelectedStyleGuide = deleteSelectedStyleGuide;
      window.viewSelectedStyleGuide = viewSelectedStyleGuide;
      window.previewSelectedStyleGuide = previewSelectedStyleGuide;
      window.closeViewStyleGuideModal = closeViewStyleGuideModal;
      window.toggleEditMode = toggleEditMode;
      window.saveStyleGuideChanges = saveStyleGuideChanges;
      window.copyStyleGuideCSS = copyStyleGuideCSS;

      window.toggleStyleGuideView = toggleStyleGuideView;
      window.editStyleGuideCSS = editStyleGuideCSS;
      window.toggleLLMOptions = toggleLLMOptions;

      let currentExportData = null;
      let appliedStyles = null;
    </script>
  </body>
</html>

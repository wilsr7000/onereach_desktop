#!/usr/bin/env node

/**
 * Fixture Generator for Conversion Tests
 *
 * Generates deterministic sample files used by converter agent tests.
 * Uses only built-in Node.js modules (fs, path).
 *
 * Usage:
 *   node test/fixtures/conversion/generate-fixtures.js          # skip existing
 *   node test/fixtures/conversion/generate-fixtures.js --force   # regenerate all
 */

const fs = require('fs');
const path = require('path');

// ── helpers ──────────────────────────────────────────────────────────────────

const BASE = path.resolve(__dirname);
const EXPECTED = path.join(BASE, 'expected');
const force = process.argv.includes('--force');

function ensureDir(dir) {
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
    console.log(`  Created directory: ${path.relative(process.cwd(), dir)}`);
  }
}

function writeFixture(filePath, content) {
  const rel = path.relative(process.cwd(), filePath);
  if (!force && fs.existsSync(filePath)) {
    console.log(`  SKIP (exists): ${rel}`);
    return false;
  }
  fs.writeFileSync(filePath, content, 'utf-8');
  console.log(`  WROTE: ${rel}`);
  return true;
}

// ── fixture data ─────────────────────────────────────────────────────────────

const csvHeaders = ['id', 'name', 'email', 'age', 'city'];
const csvRows = [
  [1, 'Alice Johnson', 'alice@example.com', 28, 'New York'],
  [2, 'Bob Smith', 'bob@example.com', 34, 'San Francisco'],
  [3, 'Carol Williams', 'carol@example.com', 42, 'Chicago'],
  [4, 'David Brown', 'david@example.com', 23, 'Austin'],
  [5, 'Eve Davis', 'eve@example.com', 31, 'Seattle'],
  [6, 'Frank Miller', 'frank@example.com', 45, 'Denver'],
  [7, 'Grace Wilson', 'grace@example.com', 29, 'Boston'],
  [8, 'Hank Moore', 'hank@example.com', 37, 'Portland'],
  [9, 'Ivy Taylor', 'ivy@example.com', 26, 'Miami'],
  [10, 'Jack Anderson', 'jack@example.com', 52, 'Dallas'],
  [11, 'Karen Thomas', 'karen@example.com', 33, 'Atlanta'],
  [12, 'Leo Jackson', 'leo@example.com', 41, 'Phoenix'],
  [13, 'Mona White', 'mona@example.com', 30, 'Minneapolis'],
  [14, 'Nate Harris', 'nate@example.com', 27, 'Nashville'],
  [15, 'Olive Martin', 'olive@example.com', 38, 'San Diego'],
  [16, 'Pete Garcia', 'pete@example.com', 44, 'Detroit'],
  [17, 'Quinn Martinez', 'quinn@example.com', 35, 'Philadelphia'],
  [18, 'Rose Robinson', 'rose@example.com', 22, 'Charlotte'],
  [19, 'Sam Clark', 'sam@example.com', 48, 'Columbus'],
  [20, 'Tina Lewis', 'tina@example.com', 36, 'Indianapolis'],
];

// ── generators ───────────────────────────────────────────────────────────────

function generateMarkdown() {
  return `# Sample Document

## Introduction

This is a sample Markdown document used for conversion testing.
It contains a variety of common Markdown elements.

## Features

- Headings at multiple levels
- Unordered and ordered lists
- Code blocks with syntax highlighting
- Tables with alignment
- Links and emphasis

### Ordered Steps

1. Parse the input document
2. Apply the conversion strategy
3. Validate the output quality
4. Return the result with a report

## Code Example

\`\`\`python
def greet(name: str) -> str:
    \"\"\"Return a greeting message.\"\"\"
    return f"Hello, {name}!"

if __name__ == "__main__":
    print(greet("World"))
\`\`\`

## Data Table

| ID | Name           | Score |
|----|----------------|------:|
| 1  | Alpha          |    95 |
| 2  | Beta           |    87 |
| 3  | Gamma          |    72 |
| 4  | Delta          |    91 |

## References

For more information see the [project documentation](https://example.com/docs).

---

*Generated by generate-fixtures.js for testing purposes.*
`;
}

function generateHTML() {
  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sample Article</title>
</head>
<body>
  <article>
    <h1>Sample Article</h1>

    <h2>Introduction</h2>
    <p>This is a sample HTML document used for conversion testing. It contains
    common semantic HTML elements that converter agents must handle.</p>

    <h2>Key Points</h2>
    <ul>
      <li>Semantic HTML structure</li>
      <li>Headings, paragraphs, and lists</li>
      <li>Links and emphasis</li>
      <li>Clean, well-formed markup</li>
    </ul>

    <h2>Details</h2>
    <p>The converter should preserve the <strong>structure</strong> and
    <em>meaning</em> of the content during transformation. Inline elements
    like <a href="https://example.com">links</a> should be handled
    appropriately based on the target format.</p>

    <h2>Conclusion</h2>
    <p>A successful conversion maintains content fidelity while adapting
    to the conventions of the target format.</p>
  </article>
</body>
</html>
`;
}

function generateCSV() {
  const lines = [csvHeaders.join(',')];
  for (const row of csvRows) {
    lines.push(row.join(','));
  }
  return lines.join('\n') + '\n';
}

function generateJSON() {
  const objects = csvRows.map(row => {
    const obj = {};
    csvHeaders.forEach((h, i) => {
      obj[h] = row[i];
    });
    return obj;
  });
  return JSON.stringify(objects, null, 2) + '\n';
}

function generateYAML() {
  return `# Sample configuration for conversion testing
app:
  name: TestApp
  version: "1.0.0"
  debug: false

database:
  host: localhost
  port: 5432
  name: testdb
  pool_size: 10

features:
  - name: conversion
    enabled: true
  - name: export
    enabled: false

logging:
  level: info
  format: json
  output: stdout
`;
}

function generatePython() {
  return `#!/usr/bin/env python3
"""Sample Python module for conversion testing."""


class DataProcessor:
    """Processes data records with configurable transforms."""

    def __init__(self, name: str, threshold: float = 0.5):
        self.name = name
        self.threshold = threshold
        self._records: list[dict] = []

    def add_record(self, record: dict) -> None:
        """Add a record to the processor."""
        if not isinstance(record, dict):
            raise TypeError(f"Expected dict, got {type(record).__name__}")
        self._records.append(record)

    def filter(self, key: str, min_value: float) -> list[dict]:
        """Filter records where key >= min_value."""
        return [r for r in self._records if r.get(key, 0) >= min_value]

    @property
    def count(self) -> int:
        """Return the number of stored records."""
        return len(self._records)


def summarize(processor: DataProcessor) -> str:
    """Return a human-readable summary of the processor state."""
    return f"Processor '{processor.name}' has {processor.count} records (threshold={processor.threshold})"


if __name__ == "__main__":
    dp = DataProcessor("demo", threshold=0.7)
    dp.add_record({"score": 0.9, "label": "good"})
    dp.add_record({"score": 0.4, "label": "poor"})
    print(summarize(dp))
    print(f"Filtered (>=0.5): {dp.filter('score', 0.5)}")
`;
}

function generateNotebook() {
  const notebook = {
    nbformat: 4,
    nbformat_minor: 5,
    metadata: {
      kernelspec: {
        display_name: 'Python 3',
        language: 'python',
        name: 'python3',
      },
      language_info: {
        name: 'python',
        version: '3.11.0',
      },
    },
    cells: [
      {
        cell_type: 'markdown',
        metadata: {},
        source: [
          '# Sample Notebook\n',
          '\n',
          'This notebook demonstrates basic data processing for conversion testing.',
        ],
      },
      {
        cell_type: 'code',
        metadata: {},
        source: [
          'import json\n',
          '\n',
          'data = [\n',
          '    {"name": "Alice", "score": 95},\n',
          '    {"name": "Bob", "score": 87},\n',
          '    {"name": "Carol", "score": 72},\n',
          ']\n',
          '\n',
          'print(f"Records: {len(data)}")\n',
          'print(json.dumps(data, indent=2))',
        ],
        execution_count: 1,
        outputs: [
          {
            output_type: 'stream',
            name: 'stdout',
            text: ['Records: 3\n', '[\n', '  {"name": "Alice", "score": 95},\n', '  {"name": "Bob", "score": 87},\n', '  {"name": "Carol", "score": 72}\n', ']\n'],
          },
        ],
      },
      {
        cell_type: 'markdown',
        metadata: {},
        source: [
          '## Analysis\n',
          '\n',
          'Compute the average score and find the top performer.',
        ],
      },
      {
        cell_type: 'code',
        metadata: {},
        source: [
          'avg = sum(d["score"] for d in data) / len(data)\n',
          'top = max(data, key=lambda d: d["score"])\n',
          '\n',
          'print(f"Average score: {avg:.1f}")\n',
          'print(f"Top performer: {top[\'name\']} ({top[\'score\']})")',
        ],
        execution_count: 2,
        outputs: [
          {
            output_type: 'stream',
            name: 'stdout',
            text: ['Average score: 84.7\n', 'Top performer: Alice (95)\n'],
          },
        ],
      },
    ],
  };
  return JSON.stringify(notebook, null, 2) + '\n';
}

function generatePlaybook() {
  const playbook = {
    id: 'playbook-test-001',
    title: 'Customer Onboarding Playbook',
    content: 'This playbook outlines the standard process for onboarding new enterprise customers. It covers initial setup, configuration, training, and handoff to the success team.',
    keywords: ['onboarding', 'enterprise', 'customer-success', 'setup'],
    status: 'published',
    framework: {
      phases: [
        {
          id: 'phase-1',
          name: 'Discovery',
          description: 'Gather requirements and understand customer needs',
          steps: [
            { id: 'step-1-1', action: 'Schedule kickoff call', owner: 'account-manager' },
            { id: 'step-1-2', action: 'Document technical requirements', owner: 'solutions-engineer' },
          ],
        },
        {
          id: 'phase-2',
          name: 'Configuration',
          description: 'Set up the environment and configure integrations',
          steps: [
            { id: 'step-2-1', action: 'Provision tenant', owner: 'platform-team' },
            { id: 'step-2-2', action: 'Configure SSO and permissions', owner: 'security-team' },
            { id: 'step-2-3', action: 'Set up data integrations', owner: 'solutions-engineer' },
          ],
        },
        {
          id: 'phase-3',
          name: 'Training and Handoff',
          description: 'Train users and transition to ongoing support',
          steps: [
            { id: 'step-3-1', action: 'Conduct admin training', owner: 'training-team' },
            { id: 'step-3-2', action: 'Conduct end-user training', owner: 'training-team' },
            { id: 'step-3-3', action: 'Handoff to customer success', owner: 'account-manager' },
          ],
        },
      ],
      metrics: {
        targetDays: 30,
        checkpoints: ['kickoff-complete', 'env-ready', 'training-done', 'handoff-done'],
      },
    },
    createdAt: '2025-01-15T10:00:00Z',
    updatedAt: '2025-06-20T14:30:00Z',
    version: '2.1.0',
  };
  return JSON.stringify(playbook, null, 2) + '\n';
}

// ── expected outputs ─────────────────────────────────────────────────────────

function generateExpectedCsvToJson() {
  const objects = csvRows.map(row => {
    const obj = {};
    csvHeaders.forEach((h, i) => {
      obj[h] = row[i];
    });
    return obj;
  });
  return JSON.stringify(objects, null, 2) + '\n';
}

function generateExpectedMdToText() {
  return `Sample Document

Introduction

This is a sample Markdown document used for conversion testing.
It contains a variety of common Markdown elements.

Features

- Headings at multiple levels
- Unordered and ordered lists
- Code blocks with syntax highlighting
- Tables with alignment
- Links and emphasis

Ordered Steps

1. Parse the input document
2. Apply the conversion strategy
3. Validate the output quality
4. Return the result with a report

Code Example

def greet(name: str) -> str:
    \"Return a greeting message.\"
    return f"Hello, {name}!"

if __name__ == "__main__":
    print(greet("World"))

Data Table

ID  Name           Score
1   Alpha             95
2   Beta              87
3   Gamma             72
4   Delta             91

References

For more information see the project documentation (https://example.com/docs).

Generated by generate-fixtures.js for testing purposes.
`;
}

// ── main ─────────────────────────────────────────────────────────────────────

function main() {
  console.log('\nGenerating conversion test fixtures...\n');

  ensureDir(BASE);
  ensureDir(EXPECTED);

  let written = 0;
  let skipped = 0;

  const fixtures = [
    [path.join(BASE, 'sample.md'), generateMarkdown()],
    [path.join(BASE, 'sample.html'), generateHTML()],
    [path.join(BASE, 'sample.csv'), generateCSV()],
    [path.join(BASE, 'sample.json'), generateJSON()],
    [path.join(BASE, 'sample.yaml'), generateYAML()],
    [path.join(BASE, 'sample-code.py'), generatePython()],
    [path.join(BASE, 'sample.ipynb'), generateNotebook()],
    [path.join(BASE, 'sample-playbook.json'), generatePlaybook()],
    [path.join(EXPECTED, 'sample-csv-to-json.json'), generateExpectedCsvToJson()],
    [path.join(EXPECTED, 'sample-md-to-text.txt'), generateExpectedMdToText()],
  ];

  for (const [filePath, content] of fixtures) {
    if (writeFixture(filePath, content)) {
      written++;
    } else {
      skipped++;
    }
  }

  console.log(`\nDone. ${written} written, ${skipped} skipped (use --force to regenerate).`);
  console.log(`Fixture directory: ${path.relative(process.cwd(), BASE)}\n`);
}

main();

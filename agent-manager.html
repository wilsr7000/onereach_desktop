<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Agents</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        background: #1a1a24;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: #e0e0e0;
        overflow: hidden;
      }

      /* Dark scrollbars */
      * {
        scrollbar-width: thin;
        scrollbar-color: #3a3a4a #1a1a24;
      }

      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      ::-webkit-scrollbar-track {
        background: #1a1a24;
        border-radius: 5px;
      }

      ::-webkit-scrollbar-thumb {
        background: #3a3a4a;
        border-radius: 5px;
        border: 2px solid #1a1a24;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #4a4a5a;
      }

      ::-webkit-scrollbar-corner {
        background: #1a1a24;
      }

      .window-container {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      /* Titlebar */
      .titlebar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        -webkit-app-region: drag;
      }

      .titlebar-title {
        font-weight: 600;
        font-size: 14px;
        color: #fff;
      }

      .titlebar-close {
        -webkit-app-region: no-drag;
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: #888;
        font-size: 18px;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .titlebar-close:hover {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 0;
        padding: 0 16px;
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .tab {
        padding: 12px 20px;
        background: transparent;
        border: none;
        color: #888;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .tab:hover {
        color: #ccc;
      }

      .tab.active {
        color: #c4b5fd;
        border-bottom-color: #8b5cf6;
      }

      /* Content */
      .content {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .tab-content {
        display: none;
        flex: 1;
        overflow: auto;
        padding: 16px;
      }

      .tab-content.active {
        display: flex;
        flex-direction: column;
      }

      /* Toolbar */
      .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .toolbar-title {
        font-size: 12px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn {
        padding: 8px 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        color: #ccc;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .btn.primary {
        background: rgba(139, 92, 246, 0.2);
        border-color: rgba(139, 92, 246, 0.3);
        color: #c4b5fd;
      }

      .btn.primary:hover {
        background: rgba(139, 92, 246, 0.3);
      }

      .btn.danger {
        background: rgba(239, 68, 68, 0.15);
        border-color: rgba(239, 68, 68, 0.3);
        color: #fca5a5;
      }

      .btn.danger:hover {
        background: rgba(239, 68, 68, 0.25);
      }

      /* Agent List */
      .agent-list {
        flex: 1;
        overflow: auto;
      }

      .agent-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        transition: all 0.2s;
      }

      .agent-card:hover {
        border-color: rgba(255, 255, 255, 0.15);
      }

      .agent-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .agent-name {
        font-weight: 600;
        font-size: 14px;
        color: #fff;
      }

      .agent-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .toggle-switch {
        position: relative;
        width: 40px;
        height: 22px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 11px;
        transition: 0.2s;
      }

      .toggle-slider:before {
        position: absolute;
        content: '';
        height: 16px;
        width: 16px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.2s;
      }

      input:checked + .toggle-slider {
        background: #8b5cf6;
      }

      input:checked + .toggle-slider:before {
        transform: translateX(18px);
      }

      .agent-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }

      .keyword-tag {
        padding: 3px 8px;
        background: rgba(139, 92, 246, 0.15);
        border-radius: 6px;
        font-size: 11px;
        color: #c4b5fd;
      }

      .agent-prompt {
        margin-top: 8px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        font-size: 12px;
        color: #888;
        line-height: 1.4;
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* GSX Connection Card */
      .gsx-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
      }

      .gsx-url {
        font-size: 11px;
        color: #666;
        margin-top: 4px;
        font-family: monospace;
      }

      .gsx-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
      }

      .gsx-status.connected {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
      }

      .gsx-status.disconnected {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
      }

      .gsx-agents {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 12px;
        color: #888;
      }

      /* Store Card */
      .store-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        gap: 16px;
        transition: all 0.2s;
      }

      .store-card:hover {
        border-color: rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.05);
      }

      .store-card.enabled {
        border-color: rgba(139, 92, 246, 0.3);
      }

      .store-card-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: rgba(139, 92, 246, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
      }

      .store-card-icon.time {
        background: rgba(59, 130, 246, 0.15);
      }
      .store-card-icon.media {
        background: rgba(236, 72, 153, 0.15);
      }
      .store-card-icon.search {
        background: rgba(34, 197, 94, 0.15);
      }
      .store-card-icon.help {
        background: rgba(251, 191, 36, 0.15);
      }
      .store-card-icon.spelling {
        background: rgba(99, 102, 241, 0.15);
      }
      .store-card-icon.weather {
        background: rgba(6, 182, 212, 0.15);
      }

      .store-card-content {
        flex: 1;
        min-width: 0;
      }

      .store-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
      }

      .store-card-name {
        font-weight: 600;
        font-size: 14px;
        color: #fff;
      }

      .store-card-badge {
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .store-card-badge.builtin {
        background: rgba(139, 92, 246, 0.2);
        color: #c4b5fd;
      }

      .store-card-badge.custom {
        background: rgba(34, 197, 94, 0.2);
        color: #86efac;
      }

      .store-card-description {
        font-size: 13px;
        color: #999;
        line-height: 1.4;
        margin-bottom: 8px;
      }

      .store-card-capabilities {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
      }

      .capability-tag {
        padding: 3px 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        font-size: 11px;
        color: #888;
      }

      .store-card-examples {
        font-size: 11px;
        color: #666;
        font-style: italic;
      }

      .store-card-examples strong {
        color: #888;
        font-style: normal;
      }

      .store-card-actions {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 8px;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: #666;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state-title {
        font-size: 16px;
        font-weight: 600;
        color: #888;
        margin-bottom: 8px;
      }

      .empty-state-text {
        font-size: 13px;
        margin-bottom: 16px;
      }

      /* Modal */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 100;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.visible {
        display: flex;
      }

      .modal {
        background: #1e1e2e;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        width: 700px;
        max-width: 90vw;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .modal-title {
        font-weight: 600;
        font-size: 16px;
        color: #fff;
      }

      .modal-close {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: #888;
        font-size: 18px;
        cursor: pointer;
        border-radius: 6px;
      }

      .modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .modal-body {
        padding: 24px;
        overflow: auto;
        max-height: 70vh;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        font-size: 12px;
        font-weight: 500;
        color: #888;
        margin-bottom: 6px;
      }

      .form-input {
        width: 100%;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: #e0e0e0;
        font-size: 13px;
        outline: none;
        transition: border-color 0.2s;
      }

      .form-input:focus {
        border-color: rgba(139, 92, 246, 0.5);
      }

      .form-textarea {
        min-height: 180px;
        resize: vertical;
      }

      .form-hint {
        font-size: 11px;
        color: #666;
        margin-top: 4px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        padding: 16px 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }
    </style>
  </head>
  <body>
    <div class="window-container">
      <div class="titlebar">
        <span class="titlebar-title">Manage Agents</span>
        <button class="titlebar-close" id="closeBtn">&times;</button>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="store">Agent Store</button>
        <button class="tab" data-tab="local">My Agents</button>
        <button class="tab" data-tab="test">Test Agents</button>
        <button class="tab" data-tab="gsx">GSX Connections</button>
      </div>

      <div class="content">
        <!-- Agent Store Tab -->
        <div class="tab-content active" id="tab-store">
          <div class="toolbar">
            <span class="toolbar-title">Available Agents</span>
            <div style="display: flex; gap: 12px; align-items: center">
              <input
                type="text"
                class="form-input"
                id="storeSearch"
                placeholder="Search agents..."
                style="width: 200px; padding: 6px 12px"
              />
              <button class="btn primary" id="createCustomAgentBtn">+ Create Custom Agent</button>
            </div>
          </div>
          <div class="agent-list" id="storeList">
            <!-- Built-in agents will be rendered here -->
          </div>
        </div>

        <!-- Local Agents Tab -->
        <div class="tab-content" id="tab-local">
          <div class="toolbar">
            <span class="toolbar-title">Your Custom Agents</span>
            <button class="btn primary" id="addAgentBtn">+ New Agent</button>
          </div>
          <div class="agent-list" id="agentList">
            <!-- Agents will be rendered here -->
          </div>
        </div>

        <!-- Test Agents Tab -->
        <div class="tab-content" id="tab-test">
          <div class="toolbar">
            <span class="toolbar-title">Test Agent Bidding</span>
          </div>
          <div class="test-container" style="display: flex; gap: 24px; height: calc(100% - 50px)">
            <!-- Test Input Panel -->
            <div class="test-input-panel" style="flex: 1; display: flex; flex-direction: column">
              <div class="form-group">
                <label class="form-label">Test Phrase</label>
                <input
                  type="text"
                  class="form-input"
                  id="testPhrase"
                  placeholder="e.g., What's the weather like today?"
                  style="font-size: 16px; padding: 14px"
                />
                <span class="form-hint">Enter a phrase to see which agents would bid and their confidence</span>
              </div>

              <div class="form-group">
                <label class="form-label">Test Mode</label>
                <div style="display: flex; gap: 12px">
                  <label style="display: flex; align-items: center; gap: 6px; cursor: pointer">
                    <input type="radio" name="testMode" value="all" checked style="accent-color: #8b5cf6" />
                    <span style="font-size: 13px">All Agents</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 6px; cursor: pointer">
                    <input type="radio" name="testMode" value="single" style="accent-color: #8b5cf6" />
                    <span style="font-size: 13px">Single Agent</span>
                  </label>
                </div>
              </div>

              <div class="form-group" id="singleAgentSelect" style="display: none">
                <label class="form-label">Select Agent</label>
                <select class="form-input" id="testAgentId">
                  <!-- Populated dynamically -->
                </select>
              </div>

              <div style="display: flex; gap: 8px; margin-top: 8px">
                <button class="btn primary" id="runTestBtn" style="padding: 12px; flex: 1">Test Agent</button>
                <button
                  class="btn"
                  id="cancelTestBtn"
                  style="padding: 12px; background: rgba(239, 68, 68, 0.15); color: #ef4444; display: none"
                >
                  Cancel
                </button>
              </div>

              <div id="testStatus" style="margin-top: 16px; font-size: 12px; color: #888"></div>

              <!-- Auto Test Section -->
              <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1)">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px">
                  <span style="font-size: 13px; font-weight: 500; color: #a78bfa">Auto Test Mode</span>
                  <span
                    style="
                      font-size: 11px;
                      color: #666;
                      background: rgba(255, 255, 255, 0.05);
                      padding: 2px 8px;
                      border-radius: 4px;
                    "
                    >AI-Generated</span
                  >
                </div>
                <div class="form-group">
                  <label class="form-label">Test Theme / Prompt</label>
                  <textarea
                    class="form-input"
                    id="autoTestPrompt"
                    rows="2"
                    placeholder="e.g., Test mood-related requests, music controls, greetings..."
                    style="font-size: 13px; resize: vertical"
                  ></textarea>
                  <span class="form-hint">AI will generate test phrases based on this theme</span>
                </div>
                <div class="form-group" style="display: flex; gap: 12px; align-items: center">
                  <label style="font-size: 12px; color: #888">Phrases per batch:</label>
                  <select class="form-input" id="autoTestBatchSize" style="width: 80px; padding: 6px">
                    <option value="3">3</option>
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                  </select>
                  <label style="font-size: 12px; color: #888; margin-left: 12px">Delay (ms):</label>
                  <input
                    type="number"
                    class="form-input"
                    id="autoTestDelay"
                    value="1500"
                    min="500"
                    max="10000"
                    step="500"
                    style="width: 80px; padding: 6px"
                  />
                </div>
                <div style="display: flex; gap: 8px">
                  <button
                    class="btn"
                    id="startAutoTestBtn"
                    style="padding: 10px 16px; background: rgba(167, 139, 250, 0.15); color: #a78bfa; flex: 1"
                  >
                    Start Auto Test
                  </button>
                  <button
                    class="btn"
                    id="stopAutoTestBtn"
                    style="padding: 10px 16px; background: rgba(239, 68, 68, 0.15); color: #ef4444; display: none"
                  >
                    Stop
                  </button>
                </div>
                <div id="autoTestStatus" style="margin-top: 12px; font-size: 11px; color: #666"></div>
              </div>
            </div>

            <!-- Results Panel -->
            <div
              class="test-results-panel"
              style="flex: 2; background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 16px; overflow: auto"
            >
              <div class="toolbar-title" style="margin-bottom: 12px">Bid Results</div>
              <div id="testResults">
                <div class="empty-state" style="padding: 32px">
                  <div class="empty-state-title">Enter a phrase and click Evaluate</div>
                  <div class="empty-state-text">
                    See how agents would bid on this task in real-time using LLM evaluation
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- GSX Connections Tab -->
        <div class="tab-content" id="tab-gsx">
          <div class="toolbar">
            <span class="toolbar-title">MCS Server Connections</span>
            <button class="btn primary" id="addGSXBtn">+ Add Server</button>
          </div>
          <div class="agent-list" id="gsxList">
            <!-- GSX connections will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Agent Modal -->
    <div class="modal-overlay" id="agentModal">
      <div class="modal">
        <div class="modal-header">
          <span class="modal-title" id="agentModalTitle">New Agent</span>
          <button class="modal-close" id="agentModalClose">&times;</button>
        </div>
        <div class="modal-body">
          <form id="agentForm">
            <input type="hidden" id="agentId" />

            <!-- Basic Info -->
            <div class="form-group">
              <label class="form-label">Agent Name</label>
              <input type="text" class="form-input" id="agentName" placeholder="e.g., Weather Assistant" required />
            </div>

            <div class="form-row" style="display: flex; gap: 16px">
              <div class="form-group" style="flex: 1">
                <label class="form-label">Execution Type</label>
                <select class="form-input" id="agentExecutionType">
                  <option value="llm">LLM (Conversational)</option>
                  <option value="applescript">AppleScript (macOS)</option>
                  <option value="shell">Shell Command</option>
                  <option value="nodejs">Node.js Script</option>
                </select>
                <span class="form-hint">How the agent executes tasks</span>
              </div>
              <div class="form-group" style="flex: 1">
                <label class="form-label">Confidence Threshold</label>
                <div style="display: flex; align-items: center; gap: 12px">
                  <input
                    type="range"
                    id="agentConfidence"
                    min="0"
                    max="100"
                    value="70"
                    style="flex: 1"
                    oninput="updateConfidenceDisplay(this.value)"
                  />
                  <span
                    id="confidenceDisplay"
                    style="min-width: 40px; text-align: right; font-size: 13px; color: #c4b5fd"
                    >70%</span
                  >
                </div>
                <span class="form-hint">Minimum confidence to bid on tasks</span>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Keywords</label>
              <input
                type="text"
                class="form-input"
                id="agentKeywords"
                placeholder="weather, forecast, temperature"
                required
              />
              <span class="form-hint">Comma-separated words that trigger this agent</span>
            </div>

            <div class="form-group">
              <label class="form-label">Categories</label>
              <input
                type="text"
                class="form-input"
                id="agentCategories"
                placeholder="productivity, automation, media"
              />
              <span class="form-hint">Comma-separated categories for organization</span>
            </div>

            <div class="form-group">
              <label class="form-label">Capabilities</label>
              <input
                type="text"
                class="form-input"
                id="agentCapabilities"
                placeholder="Send emails, Schedule meetings, Search contacts"
              />
              <span class="form-hint">Comma-separated list of what this agent can do</span>
            </div>

            <div class="form-group">
              <label class="form-label">Prompt / Instructions</label>
              <textarea
                class="form-input form-textarea"
                id="agentPrompt"
                placeholder="You are a helpful weather assistant..."
                required
              ></textarea>
              <span class="form-hint">Instructions for the AI when this agent handles a task</span>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn" id="agentModalCancel">Cancel</button>
          <button class="btn primary" id="agentModalSave">Save Agent</button>
        </div>
      </div>
    </div>

    <!-- Version History Modal -->
    <div class="modal-overlay" id="historyModal">
      <div class="modal" style="width: 600px">
        <div class="modal-header">
          <span class="modal-title" id="historyModalTitle">Version History</span>
          <button class="modal-close" id="historyModalClose">&times;</button>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow: auto">
          <div id="historyList">
            <!-- Version history will be rendered here -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="historyModalCancel">Close</button>
        </div>
      </div>
    </div>

    <!-- GSX Modal -->
    <div class="modal-overlay" id="gsxModal">
      <div class="modal">
        <div class="modal-header">
          <span class="modal-title" id="gsxModalTitle">Add MCS Server</span>
          <button class="modal-close" id="gsxModalClose">&times;</button>
        </div>
        <div class="modal-body">
          <form id="gsxForm">
            <input type="hidden" id="gsxId" />
            <div class="form-group">
              <label class="form-label">Connection Name</label>
              <input type="text" class="form-input" id="gsxName" placeholder="e.g., Company MCS" required />
            </div>
            <div class="form-group">
              <label class="form-label">WebSocket URL</label>
              <input type="text" class="form-input" id="gsxUrl" placeholder="wss://mcs.company.onereach.ai" required />
              <span class="form-hint">WebSocket endpoint for real-time communication</span>
            </div>
            <div class="form-group">
              <label class="form-label">API Key (Optional)</label>
              <input type="password" class="form-input" id="gsxApiKey" placeholder="Enter API key if required" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn" id="gsxModalCancel">Cancel</button>
          <button class="btn primary" id="gsxModalSave">Save Connection</button>
        </div>
      </div>
    </div>

    <script>
      // UI metadata for builtin agents (icons and examples)
      // The actual agent list comes from the backend registry
      const BUILTIN_AGENT_UI = {
        'time-agent': {
          icon: '&#128336;',
          iconClass: 'time',
          examples: ['"What time is it?"', '"What day is today?"', '"What is the date?"'],
        },
        'weather-agent': {
          icon: '&#9925;',
          iconClass: 'weather',
          examples: ['"Weather in Denver"', '"Is it going to rain?"', '"How cold is it?"'],
          requiresApiKey: true,
        },
        'calendar-query-agent': {
          icon: '&#128197;',
          iconClass: 'calendar',
          examples: ['"What\'s on my calendar?"', '"Any meetings today?"', '"Next meeting?"'],
        },
        'calendar-create-agent': {
          icon: '&#128197;',
          iconClass: 'calendar',
          examples: ['"Create a meeting at 3pm"', '"Schedule a call with Sarah"'],
        },
        'calendar-edit-agent': {
          icon: '&#128197;',
          iconClass: 'calendar',
          examples: ['"Move my 3pm to 4pm"', '"Add Sarah to the sync"'],
        },
        'calendar-delete-agent': {
          icon: '&#128197;',
          iconClass: 'calendar',
          examples: ['"Cancel the standup"', '"Delete my 2pm meeting"'],
        },
        'help-agent': {
          icon: '&#10067;',
          iconClass: 'help',
          examples: ['"What can you do?"', '"Help me"', '"List your commands"'],
        },
        'search-agent': {
          icon: '&#128269;',
          iconClass: 'search',
          examples: ['"Who invented the telephone?"', '"Define quantum computing"'],
        },
        'smalltalk-agent': {
          icon: '&#128172;',
          iconClass: 'smalltalk',
          examples: ['"Hello"', '"Thanks"', '"Goodbye"'],
        },
        'dj-agent': {
          icon: '&#127925;',
          iconClass: 'media',
          examples: ['"Play some jazz"', '"Set my music preferences"', '"I like classical in the morning"'],
        },
        'media-agent': {
          icon: '&#127926;',
          iconClass: 'media',
          examples: ['"Pause the music"', '"Skip this song"', '"Turn up the volume"'],
        },
        'spelling-agent': {
          icon: '&#128221;',
          iconClass: 'spelling',
          examples: ['"How do you spell necessary?"', '"Spell onomatopoeia"'],
        },
        // Meeting agents (meeting-agents space)
        'action-item-agent': {
          icon: '&#9745;',
          iconClass: 'meeting',
          examples: ['"Action: John sends proposal"', '"Add todo: review budget"', '"Follow up with Sarah"'],
          space: 'meeting-agents',
        },
        'decision-agent': {
          icon: '&#9878;',
          iconClass: 'meeting',
          examples: ['"Decision: use React"', '"We agreed on Q3 launch"', '"Approved the budget"'],
          space: 'meeting-agents',
        },
        'meeting-notes-agent': {
          icon: '&#9998;',
          iconClass: 'meeting',
          examples: ['"Note: discussed timeline"', '"Key point: 3 sprints needed"', '"Bookmark this moment"'],
          space: 'meeting-agents',
        },
      };

      // Built-in agents catalog (loaded from backend)
      let BUILTIN_AGENTS = [];

      // State
      let agents = [];
      let gsxConnections = [];
      let enabledBuiltinAgents = {};
      let editingAgentId = null;
      let editingGSXId = null;

      // DOM Elements
      const closeBtn = document.getElementById('closeBtn');
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      const storeList = document.getElementById('storeList');
      const storeSearch = document.getElementById('storeSearch');
      const agentList = document.getElementById('agentList');
      const gsxList = document.getElementById('gsxList');
      const addAgentBtn = document.getElementById('addAgentBtn');
      const addGSXBtn = document.getElementById('addGSXBtn');
      const createCustomAgentBtn = document.getElementById('createCustomAgentBtn');

      // Agent Modal
      const agentModal = document.getElementById('agentModal');
      const agentModalTitle = document.getElementById('agentModalTitle');
      const agentForm = document.getElementById('agentForm');
      const agentModalClose = document.getElementById('agentModalClose');
      const agentModalCancel = document.getElementById('agentModalCancel');
      const agentModalSave = document.getElementById('agentModalSave');

      // GSX Modal
      const gsxModal = document.getElementById('gsxModal');
      const gsxModalTitle = document.getElementById('gsxModalTitle');
      const gsxForm = document.getElementById('gsxForm');
      const gsxModalClose = document.getElementById('gsxModalClose');
      const gsxModalCancel = document.getElementById('gsxModalCancel');
      const gsxModalSave = document.getElementById('gsxModalSave');

      // Close window
      closeBtn.addEventListener('click', () => {
        if (window.agentManagerAPI) {
          window.agentManagerAPI.close();
        }
      });

      // Tab switching
      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;

          tabs.forEach((t) => t.classList.remove('active'));
          tabContents.forEach((tc) => tc.classList.remove('active'));

          tab.classList.add('active');
          document.getElementById('tab-' + tabId).classList.add('active');
        });
      });

      // ==================== AGENT STORE ====================

      function renderStore(filter = '') {
        const filterLower = filter.toLowerCase();
        const filteredAgents = BUILTIN_AGENTS.filter((agent) => {
          if (!filter) return true;
          return (
            agent.name.toLowerCase().includes(filterLower) ||
            agent.description.toLowerCase().includes(filterLower) ||
            agent.capabilities.some((c) => c.toLowerCase().includes(filterLower))
          );
        });

        if (filteredAgents.length === 0) {
          storeList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&mdash;</div>
                        <div class="empty-state-title">No matching agents</div>
                        <div class="empty-state-text">Try a different search term</div>
                    </div>
                `;
          return;
        }

        storeList.innerHTML = filteredAgents
          .map((agent) => {
            const isEnabled = enabledBuiltinAgents[agent.id] !== false; // Default to enabled
            return `
                    <div class="store-card ${isEnabled ? 'enabled' : ''}">
                        <div class="store-card-icon ${agent.iconClass}">${agent.icon}</div>
                        <div class="store-card-content">
                            <div class="store-card-header">
                                <span class="store-card-name">${escapeHtml(agent.name)}</span>
                                <span class="store-card-badge builtin">Built-in</span>
                                ${agent.space ? `<span class="store-card-badge" style="background:rgba(167,139,250,0.15);color:#a78bfa;">${escapeHtml(agent.space)}</span>` : ''}
                            </div>
                            <div class="store-card-description">${escapeHtml(agent.description)}</div>
                            <div class="store-card-capabilities">
                                ${agent.capabilities.map((c) => `<span class="capability-tag">${escapeHtml(c)}</span>`).join('')}
                            </div>
                            <div class="store-card-examples">
                                <strong>Try:</strong> ${agent.examples.join(' ')}
                            </div>
                        </div>
                        <div class="store-card-actions">
                            <label class="toggle-switch">
                                <input type="checkbox" ${isEnabled ? 'checked' : ''} 
                                       onchange="toggleBuiltinAgent('${agent.id}', this.checked)" />
                                <span class="toggle-slider"></span>
                            </label>
                            ${agent.requiresApiKey ? '<span style="font-size: 10px; color: #f59e0b;">Needs API key</span>' : ''}
                        </div>
                    </div>
                `;
          })
          .join('');
      }

      async function toggleBuiltinAgent(agentId, enabled) {
        enabledBuiltinAgents[agentId] = enabled;

        try {
          await window.agentManagerAPI.setBuiltinAgentEnabled(agentId, enabled);
          renderStore(storeSearch.value);
        } catch (error) {
          console.error('Error toggling agent:', error);
          // Revert the state
          enabledBuiltinAgents[agentId] = !enabled;
          renderStore(storeSearch.value);
        }
      }

      async function loadBuiltinAgentStates() {
        try {
          // Load enabled states
          enabledBuiltinAgents = (await window.agentManagerAPI.getBuiltinAgentStates()) || {};

          // Load builtin agents from registry (single source of truth)
          const registryAgents = (await window.agentManagerAPI.getBuiltinAgents()) || [];

          // Merge registry agents with UI metadata
          BUILTIN_AGENTS = registryAgents.map((agent) => {
            const ui = BUILTIN_AGENT_UI[agent.id] || {};
            return {
              ...agent,
              icon: ui.icon || '&#129302;', // Default robot icon
              iconClass: ui.iconClass || 'default',
              examples: ui.examples || [],
              requiresApiKey: ui.requiresApiKey || false,
              space: ui.space || null,
              builtin: true,
            };
          });

          console.log(`[AgentManager] Loaded ${BUILTIN_AGENTS.length} builtin agents from registry`);
        } catch (error) {
          console.error('Error loading agent states:', error);
          enabledBuiltinAgents = {};
          BUILTIN_AGENTS = [];
        }
        renderStore();
      }

      // ==================== LOCAL AGENTS ====================

      function renderAgents() {
        if (agents.length === 0) {
          agentList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&mdash;</div>
                        <div class="empty-state-title">No agents yet</div>
                        <div class="empty-state-text">Create your first voice agent to get started</div>
                        <button class="btn primary" onclick="showAgentModal()">+ Create Agent</button>
                    </div>
                `;
          return;
        }

        agentList.innerHTML = agents
          .map(
            (agent) => `
                <div class="agent-card">
                    <div class="agent-card-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="agent-name">${escapeHtml(agent.name)}</span>
                            <span class="execution-type-badge" style="
                                padding: 2px 8px;
                                border-radius: 10px;
                                font-size: 10px;
                                background: rgba(139, 92, 246, 0.15);
                                color: #c4b5fd;
                            ">${agent.executionType || 'llm'}</span>
                            ${agent.version ? `<span style="font-size: 10px; color: #666;">v${agent.version}</span>` : ''}
                        </div>
                        <div class="agent-actions">
                            <label class="toggle-switch">
                                <input type="checkbox" ${agent.enabled ? 'checked' : ''} 
                                       onchange="toggleAgent('${agent.id}', this.checked)" />
                                <span class="toggle-slider"></span>
                            </label>
                            <button class="btn" onclick="testSingleAgent('${agent.id}')" title="Test this agent">Test</button>
                            <button class="btn" onclick="addFeatureToAgent('${agent.id}')" title="Add new capability">+ Feature</button>
                            <button class="btn" onclick="showVersionHistory('${agent.id}')" title="Version history">History</button>
                            <button class="btn" onclick="editAgent('${agent.id}')">Edit</button>
                            <button class="btn danger" onclick="deleteAgent('${agent.id}')">Delete</button>
                        </div>
                    </div>
                    <div class="agent-keywords">
                        ${agent.keywords.map((kw) => `<span class="keyword-tag">${escapeHtml(kw)}</span>`).join('')}
                    </div>
                    ${
                      agent.capabilities && agent.capabilities.length > 0
                        ? `
                        <div class="agent-capabilities" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                            ${agent.capabilities.map((cap) => `<span class="capability-tag">${escapeHtml(cap)}</span>`).join('')}
                        </div>
                    `
                        : ''
                    }
                    <div class="agent-prompt">${escapeHtml(agent.prompt)}</div>
                    ${
                      agent.settings?.confidenceThreshold
                        ? `
                        <div style="margin-top: 8px; font-size: 11px; color: #666;">
                            Confidence threshold: ${Math.round((agent.settings.confidenceThreshold || 0.7) * 100)}%
                        </div>
                    `
                        : ''
                    }
                    <div class="agent-stats" id="stats-${agent.id}" style="
                        margin-top: 10px;
                        padding-top: 10px;
                        border-top: 1px solid rgba(255, 255, 255, 0.05);
                        display: flex;
                        gap: 16px;
                        font-size: 11px;
                        color: #666;
                    ">
                        <span>Loading stats...</span>
                    </div>
                </div>
            `
          )
          .join('');

        // Load stats for each agent
        loadAgentStats();
      }

      // Confidence slider display
      function updateConfidenceDisplay(value) {
        document.getElementById('confidenceDisplay').textContent = value + '%';
      }

      function showAgentModal(agent = null) {
        editingAgentId = agent?.id || null;
        agentModalTitle.textContent = agent ? 'Edit Agent' : 'New Agent';

        document.getElementById('agentId').value = agent?.id || '';
        document.getElementById('agentName').value = agent?.name || '';
        document.getElementById('agentKeywords').value = (agent?.keywords || []).join(', ');
        document.getElementById('agentPrompt').value = agent?.prompt || '';

        // New fields
        document.getElementById('agentExecutionType').value = agent?.executionType || 'llm';
        document.getElementById('agentCategories').value = (agent?.categories || []).join(', ');
        document.getElementById('agentCapabilities').value = (agent?.capabilities || []).join(', ');

        const confidence = Math.round((agent?.settings?.confidenceThreshold || 0.7) * 100);
        document.getElementById('agentConfidence').value = confidence;
        document.getElementById('confidenceDisplay').textContent = confidence + '%';

        agentModal.classList.add('visible');
      }

      function hideAgentModal() {
        agentModal.classList.remove('visible');
        agentForm.reset();
        editingAgentId = null;
      }

      async function saveAgent() {
        const name = document.getElementById('agentName').value.trim();
        const keywords = document
          .getElementById('agentKeywords')
          .value.split(',')
          .map((k) => k.trim().toLowerCase())
          .filter((k) => k);
        const prompt = document.getElementById('agentPrompt').value.trim();

        // New fields
        const executionType = document.getElementById('agentExecutionType').value;
        const categories = document
          .getElementById('agentCategories')
          .value.split(',')
          .map((c) => c.trim().toLowerCase())
          .filter((c) => c);
        const capabilities = document
          .getElementById('agentCapabilities')
          .value.split(',')
          .map((c) => c.trim())
          .filter((c) => c);
        const confidenceThreshold = parseInt(document.getElementById('agentConfidence').value) / 100;

        if (!name || keywords.length === 0 || !prompt) {
          alert('Please fill in all required fields');
          return;
        }

        const agentData = {
          name,
          keywords,
          prompt,
          executionType,
          categories: categories.length > 0 ? categories : ['general'],
          capabilities,
          settings: {
            confidenceThreshold,
          },
        };

        try {
          if (editingAgentId) {
            await window.agentManagerAPI.updateAgent(editingAgentId, agentData);
          } else {
            await window.agentManagerAPI.createAgent(agentData);
          }

          hideAgentModal();
          await loadAgents();
        } catch (error) {
          alert('Error saving agent: ' + error.message);
        }
      }

      async function editAgent(id) {
        const agent = agents.find((a) => a.id === id);
        if (agent) {
          showAgentModal(agent);
        }
      }

      async function deleteAgent(id) {
        if (!confirm('Are you sure you want to delete this agent?')) return;

        try {
          await window.agentManagerAPI.deleteAgent(id);
          await loadAgents();
        } catch (error) {
          alert('Error deleting agent: ' + error.message);
        }
      }

      async function toggleAgent(id, enabled) {
        try {
          await window.agentManagerAPI.updateAgent(id, { enabled });
          await loadAgents();
        } catch (error) {
          alert('Error updating agent: ' + error.message);
        }
      }

      // ==================== GSX CONNECTIONS ====================

      function renderGSXConnections() {
        if (gsxConnections.length === 0) {
          gsxList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&mdash;</div>
                        <div class="empty-state-title">No GSX connections</div>
                        <div class="empty-state-text">Connect to an MCS server to access remote agents</div>
                        <button class="btn primary" onclick="showGSXModal()">+ Add Server</button>
                    </div>
                `;
          return;
        }

        gsxList.innerHTML = gsxConnections
          .map(
            (conn) => `
                <div class="gsx-card">
                    <div class="agent-card-header">
                        <span class="agent-name">${escapeHtml(conn.name)}</span>
                        <div class="agent-actions">
                            <span class="gsx-status ${conn.connected ? 'connected' : 'disconnected'}">
                                ${conn.connected ? 'Connected' : 'Disconnected'}
                            </span>
                            <label class="toggle-switch">
                                <input type="checkbox" ${conn.enabled ? 'checked' : ''} 
                                       onchange="toggleGSX('${conn.id}', this.checked)" />
                                <span class="toggle-slider"></span>
                            </label>
                            <button class="btn" onclick="editGSX('${conn.id}')">Edit</button>
                            <button class="btn danger" onclick="deleteGSX('${conn.id}')">Delete</button>
                        </div>
                    </div>
                    <div class="gsx-url">${escapeHtml(conn.url)}</div>
                    ${
                      conn.agents && conn.agents.length > 0
                        ? `
                        <div class="gsx-agents">
                            <strong>Available agents:</strong> ${conn.agents.map((a) => a.name).join(', ')}
                        </div>
                    `
                        : ''
                    }
                </div>
            `
          )
          .join('');
      }

      function showGSXModal(conn = null) {
        editingGSXId = conn?.id || null;
        gsxModalTitle.textContent = conn ? 'Edit Connection' : 'Add MCS Server';

        document.getElementById('gsxId').value = conn?.id || '';
        document.getElementById('gsxName').value = conn?.name || '';
        document.getElementById('gsxUrl').value = conn?.url || '';
        document.getElementById('gsxApiKey').value = conn?.apiKey || '';

        gsxModal.classList.add('visible');
      }

      function hideGSXModal() {
        gsxModal.classList.remove('visible');
        gsxForm.reset();
        editingGSXId = null;
      }

      async function saveGSX() {
        const name = document.getElementById('gsxName').value.trim();
        const url = document.getElementById('gsxUrl').value.trim();
        const apiKey = document.getElementById('gsxApiKey').value.trim();

        if (!name || !url) {
          alert('Please fill in required fields');
          return;
        }

        try {
          if (editingGSXId) {
            await window.agentManagerAPI.updateGSXConnection(editingGSXId, { name, url, apiKey });
          } else {
            await window.agentManagerAPI.addGSXConnection({ name, url, apiKey });
          }

          hideGSXModal();
          await loadGSXConnections();
        } catch (error) {
          alert('Error saving connection: ' + error.message);
        }
      }

      async function editGSX(id) {
        const conn = gsxConnections.find((c) => c.id === id);
        if (conn) {
          showGSXModal(conn);
        }
      }

      async function deleteGSX(id) {
        if (!confirm('Are you sure you want to delete this connection?')) return;

        try {
          await window.agentManagerAPI.deleteGSXConnection(id);
          await loadGSXConnections();
        } catch (error) {
          alert('Error deleting connection: ' + error.message);
        }
      }

      async function toggleGSX(id, enabled) {
        try {
          await window.agentManagerAPI.updateGSXConnection(id, { enabled });
          await loadGSXConnections();
        } catch (error) {
          alert('Error updating connection: ' + error.message);
        }
      }

      // ==================== TESTING ====================

      function testSingleAgent(agentId) {
        // Switch to test tab
        tabs.forEach((t) => t.classList.remove('active'));
        tabContents.forEach((tc) => tc.classList.remove('active'));
        document.querySelector('[data-tab="test"]').classList.add('active');
        document.getElementById('tab-test').classList.add('active');

        // Set to single agent mode
        document.querySelector('input[name="testMode"][value="single"]').checked = true;
        document.getElementById('singleAgentSelect').style.display = 'block';

        // Populate and select the agent
        populateAgentSelect();
        document.getElementById('testAgentId').value = agentId;

        // Focus on phrase input
        document.getElementById('testPhrase').focus();
      }

      function populateAgentSelect() {
        const select = document.getElementById('testAgentId');
        const allAgents = [...agents];

        // Add builtin agents
        BUILTIN_AGENTS.forEach((a) => {
          if (enabledBuiltinAgents[a.id] !== false) {
            allAgents.push({ id: a.id, name: a.name, builtin: true });
          }
        });

        select.innerHTML = allAgents
          .map((a) => `<option value="${a.id}">${escapeHtml(a.name)}${a.builtin ? ' (Built-in)' : ''}</option>`)
          .join('');
      }

      let testCancelled = false;

      async function runTest() {
        const phrase = document.getElementById('testPhrase').value.trim();
        if (!phrase) {
          alert('Please enter a test phrase');
          return;
        }

        testCancelled = false;
        const testMode = document.querySelector('input[name="testMode"]:checked').value;
        const resultsContainer = document.getElementById('testResults');
        const statusEl = document.getElementById('testStatus');
        const runBtn = document.getElementById('runTestBtn');
        const cancelBtn = document.getElementById('cancelTestBtn');

        // Show cancel button, disable run button
        runBtn.disabled = true;
        cancelBtn.style.display = 'block';

        statusEl.textContent = 'Step 1: Evaluating bids...';
        resultsContainer.innerHTML =
          '<div style="text-align: center; padding: 32px; color: #888;">Running LLM evaluation...</div>';

        try {
          // STEP 1: Bidding
          let results;
          if (testMode === 'single') {
            const agentId = document.getElementById('testAgentId').value;
            const result = await window.agentManagerAPI.testPhrase(agentId, phrase);
            results = [{ agentId, ...result }];
          } else {
            results = await window.agentManagerAPI.testPhraseAllAgents(phrase);
          }

          if (testCancelled) {
            statusEl.textContent = 'Cancelled';
            runBtn.disabled = false;
            cancelBtn.style.display = 'none';
            return;
          }

          // Sort by confidence
          results.sort((a, b) => (b.confidence || 0) - (a.confidence || 0));

          // Find winner
          const winner = results.find((r) => (r.confidence || 0) > 0.1);

          // Render bid results
          renderBidResults(results, resultsContainer);

          if (!winner) {
            statusEl.textContent = 'No agent would bid on this phrase';
            runBtn.disabled = false;
            cancelBtn.style.display = 'none';
            return;
          }

          // STEP 2: Execute winner
          statusEl.textContent = `Step 2: Executing ${winner.agentName || winner.agentId}...`;

          const execStart = Date.now();
          const execResult = await window.agentManagerAPI.executeAgent(winner.agentId, phrase);
          const execTime = Date.now() - execStart;

          if (testCancelled) {
            statusEl.textContent = 'Cancelled';
            runBtn.disabled = false;
            cancelBtn.style.display = 'none';
            return;
          }

          // Render execution result
          renderExecutionResult(execResult, execTime, resultsContainer);

          statusEl.textContent = `Complete: ${winner.agentName || winner.agentId} responded in ${execTime}ms`;
        } catch (error) {
          console.error('Test error:', error);
          statusEl.textContent = 'Error: ' + error.message;
          resultsContainer.innerHTML = `<div class="empty-state"><div class="empty-state-title">Error</div><div class="empty-state-text">${escapeHtml(error.message)}</div></div>`;
        } finally {
          runBtn.disabled = false;
          cancelBtn.style.display = 'none';
        }
      }

      function cancelTest() {
        testCancelled = true;
        document.getElementById('testStatus').textContent = 'Cancelling...';
      }

      function renderBidResults(results, container) {
        container.innerHTML = results
          .map((r, i) => {
            const confidence = Math.round((r.confidence || 0) * 100);
            const wouldBid = confidence > 10;
            const isWinner = i === 0 && wouldBid;

            return `
                    <div class="test-result-card" data-agent-id="${r.agentId}" style="
                        background: ${isWinner ? 'rgba(34, 197, 94, 0.1)' : 'rgba(255, 255, 255, 0.03)'};
                        border: 1px solid ${isWinner ? 'rgba(34, 197, 94, 0.3)' : 'rgba(255, 255, 255, 0.08)'};
                        border-radius: 10px;
                        padding: 14px;
                        margin-bottom: 10px;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: 600; color: #fff;">${escapeHtml(r.agentName || r.agentId)}</span>
                                ${isWinner ? '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">WINNER</span>' : ''}
                                ${!wouldBid ? '<span style="background: rgba(239, 68, 68, 0.15); color: #ef4444; padding: 2px 8px; border-radius: 10px; font-size: 10px;">Would not bid</span>' : ''}
                            </div>
                            <span style="font-size: 18px; font-weight: 700; color: ${confidence > 70 ? '#22c55e' : confidence > 40 ? '#f59e0b' : '#ef4444'};">
                                ${confidence}%
                            </span>
                        </div>
                        <div style="
                            height: 6px;
                            background: rgba(255, 255, 255, 0.1);
                            border-radius: 3px;
                            overflow: hidden;
                            margin-bottom: 10px;
                        ">
                            <div style="
                                height: 100%;
                                width: ${confidence}%;
                                background: ${confidence > 70 ? '#22c55e' : confidence > 40 ? '#f59e0b' : '#ef4444'};
                                border-radius: 3px;
                                transition: width 0.3s;
                            "></div>
                        </div>
                        ${
                          r.plan || r.reasoning
                            ? `
                            <div style="font-size: 12px; color: #888; line-height: 1.5;">
                                <strong style="color: #aaa;">Reasoning:</strong> ${escapeHtml(r.plan || r.reasoning)}
                            </div>
                        `
                            : ''
                        }
                    </div>
                `;
          })
          .join('');
      }

      function renderExecutionResult(result, execTime, container) {
        const execCard = document.createElement('div');
        execCard.style.cssText = `
                background: rgba(139, 92, 246, 0.1);
                border: 2px solid rgba(139, 92, 246, 0.4);
                border-radius: 10px;
                padding: 16px;
                margin-top: 16px;
            `;

        const statusColor = result.success ? '#22c55e' : '#ef4444';
        const statusText = result.success ? 'SUCCESS' : 'FAILED';

        // Voice descriptions for display
        const voiceDescriptions = {
          alloy: 'Neutral, balanced',
          ash: 'Warm, friendly',
          ballad: 'Expressive, dramatic',
          coral: 'Clear, professional',
          echo: 'Authoritative',
          sage: 'Calm, wise',
          shimmer: 'Energetic, bright',
          verse: 'Natural, conversational',
        };
        const voiceDesc = voiceDescriptions[result.voice] || result.voice;

        execCard.innerHTML = `
                ${
                  result.ack
                    ? `
                    <div style="margin-bottom: 12px; padding: 10px; background: rgba(59, 130, 246, 0.15); border-radius: 8px; border-left: 3px solid #3b82f6;">
                        <div style="font-size: 10px; color: #60a5fa; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">
                            Immediate Ack (Voice: ${result.voice || 'alloy'} - ${voiceDesc})
                        </div>
                        <div style="font-size: 14px; color: #93c5fd; font-style: italic;">"${escapeHtml(result.ack)}"</div>
                    </div>
                `
                    : ''
                }
                ${
                  result.orchestrated
                    ? `
                    <div style="margin-bottom: 12px; padding: 10px; background: rgba(167, 139, 250, 0.15); border-radius: 8px; border-left: 3px solid #a78bfa;">
                        <div style="font-size: 10px; color: #c4b5fd; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">
                            Multi-Agent Orchestration
                        </div>
                        <div style="font-size: 12px; color: #a78bfa;">
                            Coordinated agents: <span style="color: #fff; font-weight: 500;">${result.agentsUsed ? result.agentsUsed.join(' + ') : 'multiple'}</span>
                        </div>
                    </div>
                `
                    : ''
                }
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: 700; color: #c4b5fd; font-size: 14px;">EXECUTION RESULT</span>
                        <span style="background: ${result.success ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; color: ${statusColor}; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">${statusText}</span>
                        ${result.voice ? `<span style="background: rgba(139, 92, 246, 0.2); color: #c4b5fd; padding: 2px 8px; border-radius: 10px; font-size: 10px;">Voice: ${result.voice}</span>` : ''}
                        ${result.orchestrated ? `<span style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; padding: 2px 8px; border-radius: 10px; font-size: 10px;">MULTI-AGENT</span>` : ''}
                    </div>
                    <span style="font-size: 12px; color: #888;">${execTime}ms</span>
                </div>
                <div style="
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    padding: 14px;
                    font-family: 'SF Mono', Monaco, monospace;
                    font-size: 13px;
                    color: #fff;
                    line-height: 1.6;
                    white-space: pre-wrap;
                    word-break: break-word;
                ">
                    ${result.message ? escapeHtml(result.message) : result.error ? `<span style="color: #ef4444;">${escapeHtml(result.error)}</span>` : '<span style="color: #888;">No response message</span>'}
                </div>
                ${
                  result.needsInput
                    ? `
                    <div style="margin-top: 12px; padding: 10px; background: rgba(251, 191, 36, 0.1); border-radius: 6px; font-size: 12px; color: #fbbf24;">
                        Agent wants more input: ${escapeHtml(result.needsInput.prompt || 'Follow-up question')}
                    </div>
                `
                    : ''
                }
            `;

        container.appendChild(execCard);
      }

      // ==================== AUTO TEST ====================

      let autoTestRunning = false;
      let autoTestCancelled = false;
      let autoTestResults = [];

      async function generateTestPhrases(prompt, count) {
        // Check if AI bridge is available
        if (!window.ai || !window.ai.chat) {
          console.log('[AgentManager] AI bridge not available, using fallback phrases');
          return getFallbackPhrases(prompt, count);
        }

        try {
          const result = await window.ai.chat({
            profile: 'fast',
            messages: [
              {
                role: 'user',
                content: `Generate ${count} diverse test phrases for a voice assistant. Theme: "${prompt}"

Return ONLY a JSON array of strings, no explanation:
["phrase 1", "phrase 2", ...]

Make them natural, varied, and realistic. Include edge cases and different phrasings.`,
              },
            ],
            maxTokens: 500,
            temperature: 0.8,
            jsonMode: true,
            feature: 'agent-manager',
          });

          let content = result.content?.trim();

          // Parse JSON array
          if (content && content.startsWith('```')) {
            content = content
              .replace(/```json?\n?/g, '')
              .replace(/```/g, '')
              .trim();
          }

          return JSON.parse(content || '[]');
        } catch (error) {
          console.error('Error generating phrases:', error);
          return getFallbackPhrases(prompt, count);
        }
      }

      function getFallbackPhrases(prompt, count) {
        const lowerPrompt = prompt.toLowerCase();

        const categories = {
          mood: [
            'cheer me up',
            "I'm feeling down",
            'having a rough day',
            'need some motivation',
            'feeling stressed',
            'help me relax',
            "I'm bored",
            'feeling tired',
            'need energy',
            'pump me up',
          ],
          music: [
            'play some music',
            'turn it up',
            'skip this song',
            "what's playing",
            'pause',
            'play something upbeat',
            'set volume to 50',
            'next track',
            'shuffle my playlist',
          ],
          greetings: [
            'hi',
            'hello there',
            'good morning',
            'hey',
            'howdy',
            "what's up",
            'how are you',
            'good evening',
            'sup',
          ],
          general: [
            'what time is it',
            "what's the weather",
            'tell me a joke',
            'set a reminder',
            'help me',
            'what can you do',
            'thanks',
            'never mind',
            'cancel that',
          ],
        };

        let phrases = [];
        if (lowerPrompt.includes('mood') || lowerPrompt.includes('emotion') || lowerPrompt.includes('cheer')) {
          phrases = [...categories.mood];
        } else if (lowerPrompt.includes('music') || lowerPrompt.includes('dj') || lowerPrompt.includes('play')) {
          phrases = [...categories.music];
        } else if (lowerPrompt.includes('greet') || lowerPrompt.includes('hello') || lowerPrompt.includes('hi')) {
          phrases = [...categories.greetings];
        } else {
          // Mix all categories
          phrases = [...categories.mood, ...categories.music, ...categories.greetings, ...categories.general];
        }

        // Shuffle and take count
        phrases.sort(() => Math.random() - 0.5);
        return phrases.slice(0, count);
      }

      async function startAutoTest() {
        const prompt = document.getElementById('autoTestPrompt').value.trim();
        if (!prompt) {
          alert('Please enter a test theme/prompt');
          return;
        }

        autoTestRunning = true;
        autoTestCancelled = false;
        autoTestResults = [];

        const batchSize = parseInt(document.getElementById('autoTestBatchSize').value);
        const delay = parseInt(document.getElementById('autoTestDelay').value);

        const startBtn = document.getElementById('startAutoTestBtn');
        const stopBtn = document.getElementById('stopAutoTestBtn');
        const statusEl = document.getElementById('autoTestStatus');
        const resultsContainer = document.getElementById('testResults');

        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';

        let totalRuns = 0;
        let batchNum = 0;

        while (autoTestRunning && !autoTestCancelled) {
          batchNum++;
          statusEl.innerHTML = `<span style="color: #a78bfa;">Batch ${batchNum}:</span> Generating ${batchSize} test phrases...`;

          // Generate test phrases
          const phrases = await generateTestPhrases(prompt, batchSize);

          if (autoTestCancelled) break;

          // Run each phrase
          for (let i = 0; i < phrases.length; i++) {
            if (autoTestCancelled) break;

            const phrase = phrases[i];
            totalRuns++;

            statusEl.innerHTML = `<span style="color: #a78bfa;">Batch ${batchNum}:</span> Testing "${phrase.substring(0, 30)}..." (${i + 1}/${phrases.length})`;

            // Run the test
            try {
              const results = await window.agentManagerAPI.testPhraseAllAgents(phrase);
              results.sort((a, b) => (b.confidence || 0) - (a.confidence || 0));

              const winner = results.find((r) => (r.confidence || 0) > 0.1);

              let execResult = null;
              if (winner) {
                execResult = await window.agentManagerAPI.executeAgent(winner.agentId, phrase);
              }

              // Store result
              autoTestResults.push({
                phrase,
                winner: winner
                  ? { agentId: winner.agentId, agentName: winner.agentName, confidence: winner.confidence }
                  : null,
                result: execResult,
                timestamp: Date.now(),
              });

              // Render incremental results
              renderAutoTestResults(resultsContainer);
            } catch (error) {
              console.error('Auto test error:', error);
              autoTestResults.push({
                phrase,
                error: error.message,
                timestamp: Date.now(),
              });
            }

            // Delay between tests
            if (!autoTestCancelled && i < phrases.length - 1) {
              await new Promise((r) => setTimeout(r, delay));
            }
          }

          // Short delay between batches
          if (!autoTestCancelled) {
            statusEl.innerHTML = `<span style="color: #22c55e;">Batch ${batchNum} complete!</span> Total: ${totalRuns} tests. Generating next batch...`;
            await new Promise((r) => setTimeout(r, 2000));
          }
        }

        // Done
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        statusEl.innerHTML = `<span style="color: #22c55e;">Stopped.</span> Ran ${totalRuns} tests across ${batchNum} batches.`;
        autoTestRunning = false;
      }

      function stopAutoTest() {
        autoTestCancelled = true;
        autoTestRunning = false;
        document.getElementById('autoTestStatus').innerHTML = '<span style="color: #f59e0b;">Stopping...</span>';
      }

      function renderAutoTestResults(container) {
        const summaryByAgent = {};
        let successCount = 0;
        let failCount = 0;
        let noWinnerCount = 0;

        autoTestResults.forEach((r) => {
          if (r.error) {
            failCount++;
          } else if (!r.winner) {
            noWinnerCount++;
          } else {
            successCount++;
            const agentId = r.winner.agentId;
            if (!summaryByAgent[agentId]) {
              summaryByAgent[agentId] = {
                name: r.winner.agentName || agentId,
                wins: 0,
                avgConfidence: 0,
                confidences: [],
              };
            }
            summaryByAgent[agentId].wins++;
            summaryByAgent[agentId].confidences.push(r.winner.confidence);
          }
        });

        // Calculate averages
        Object.values(summaryByAgent).forEach((s) => {
          s.avgConfidence = s.confidences.reduce((a, b) => a + b, 0) / s.confidences.length;
        });

        const sorted = Object.entries(summaryByAgent).sort((a, b) => b[1].wins - a[1].wins);

        container.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; color: #c4b5fd; margin-bottom: 8px;">Auto Test Summary</div>
                    <div style="display: flex; gap: 16px; font-size: 12px; color: #888;">
                        <span><span style="color: #22c55e; font-weight: 600;">${successCount}</span> handled</span>
                        <span><span style="color: #f59e0b; font-weight: 600;">${noWinnerCount}</span> no winner</span>
                        <span><span style="color: #ef4444; font-weight: 600;">${failCount}</span> errors</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 8px;">Agent Wins:</div>
                    ${sorted
                      .map(
                        ([id, s]) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 4px;">
                            <span style="font-weight: 500; color: #fff;">${escapeHtml(s.name)}</span>
                            <span style="font-size: 12px; color: #888;">
                                <span style="color: #22c55e; font-weight: 600;">${s.wins}</span> wins
                                <span style="margin-left: 8px; color: #a78bfa;">${Math.round(s.avgConfidence * 100)}% avg</span>
                            </span>
                        </div>
                    `
                      )
                      .join('')}
                </div>
                
                <div style="font-size: 12px; color: #888; margin-bottom: 8px;">Recent Tests (last 10):</div>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${autoTestResults
                      .slice(-10)
                      .reverse()
                      .map(
                        (r) => `
                        <div style="padding: 8px; background: rgba(255,255,255,0.02); border-radius: 6px; margin-bottom: 4px; font-size: 12px;">
                            <div style="color: #fff; margin-bottom: 4px;">"${escapeHtml(r.phrase.substring(0, 50))}${r.phrase.length > 50 ? '...' : ''}"</div>
                            ${
                              r.error
                                ? `<span style="color: #ef4444;">Error: ${escapeHtml(r.error)}</span>`
                                : r.winner
                                  ? `<span style="color: #22c55e;">${escapeHtml(r.winner.agentName)}</span> <span style="color: #888;">(${Math.round(r.winner.confidence * 100)}%)</span> ${r.result?.message ? ` "${escapeHtml(r.result.message.substring(0, 40))}..."` : ''}`
                                  : `<span style="color: #f59e0b;">No agent bid</span>`
                            }
                        </div>
                    `
                      )
                      .join('')}
                </div>
            `;
      }

      // Event listeners for auto test
      document.getElementById('startAutoTestBtn').addEventListener('click', startAutoTest);
      document.getElementById('stopAutoTestBtn').addEventListener('click', stopAutoTest);

      // ==================== VERSION HISTORY ====================

      let currentHistoryAgentId = null;

      async function showVersionHistory(agentId) {
        currentHistoryAgentId = agentId;
        const agent = agents.find((a) => a.id === agentId);

        document.getElementById('historyModalTitle').textContent = `History: ${agent?.name || agentId}`;

        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '<div style="text-align: center; padding: 24px; color: #888;">Loading history...</div>';

        document.getElementById('historyModal').classList.add('visible');

        try {
          const history = await window.agentManagerAPI.getVersionHistory(agentId);

          if (!history || history.length === 0) {
            historyList.innerHTML =
              '<div class="empty-state"><div class="empty-state-title">No version history</div><div class="empty-state-text">Changes to this agent will be tracked here</div></div>';
            return;
          }

          historyList.innerHTML = history
            .map(
              (v, i) => `
                    <div class="history-item" style="
                        background: rgba(255, 255, 255, 0.03);
                        border: 1px solid rgba(255, 255, 255, 0.08);
                        border-radius: 10px;
                        padding: 14px;
                        margin-bottom: 10px;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: 600; color: #c4b5fd;">Version ${v.versionNumber}</span>
                                ${i === 0 ? '<span style="background: rgba(139, 92, 246, 0.2); color: #c4b5fd; padding: 2px 8px; border-radius: 10px; font-size: 10px;">Current</span>' : ''}
                            </div>
                            <span style="font-size: 11px; color: #666;">${new Date(v.timestamp).toLocaleString()}</span>
                        </div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 8px;">
                            <span style="
                                display: inline-block;
                                padding: 2px 8px;
                                background: rgba(255, 255, 255, 0.05);
                                border-radius: 6px;
                                margin-right: 8px;
                            ">${escapeHtml(v.reason || 'updated')}</span>
                            ${v.description ? escapeHtml(v.description) : ''}
                        </div>
                        ${
                          i > 0
                            ? `
                            <div style="display: flex; gap: 8px; margin-top: 10px;">
                                <button class="btn" onclick="viewVersion('${agentId}', ${v.versionNumber})">View</button>
                                <button class="btn primary" onclick="revertToVersion('${agentId}', ${v.versionNumber})">Revert</button>
                            </div>
                        `
                            : ''
                        }
                    </div>
                `
            )
            .join('');
        } catch (error) {
          console.error('Error loading history:', error);
          historyList.innerHTML = `<div class="empty-state"><div class="empty-state-title">Error</div><div class="empty-state-text">${escapeHtml(error.message)}</div></div>`;
        }
      }

      function hideHistoryModal() {
        document.getElementById('historyModal').classList.remove('visible');
        currentHistoryAgentId = null;
      }

      async function viewVersion(agentId, versionNumber) {
        try {
          const version = await window.agentManagerAPI.getVersion(agentId, versionNumber);
          if (version && version.snapshot) {
            alert(
              `Version ${versionNumber} Details:\n\nName: ${version.snapshot.name}\nKeywords: ${version.snapshot.keywords?.join(', ')}\nPrompt: ${version.snapshot.prompt?.substring(0, 200)}...`
            );
          }
        } catch (error) {
          alert('Error loading version: ' + error.message);
        }
      }

      async function revertToVersion(agentId, versionNumber) {
        if (!confirm(`Revert to version ${versionNumber}? This will create a new version with the old settings.`))
          return;

        try {
          await window.agentManagerAPI.revertToVersion(agentId, versionNumber);
          hideHistoryModal();
          await loadAgents();
        } catch (error) {
          alert('Error reverting: ' + error.message);
        }
      }

      // ==================== ADD FEATURE ====================

      async function addFeatureToAgent(agentId) {
        const agent = agents.find((a) => a.id === agentId);
        if (!agent) {
          alert('Agent not found');
          return;
        }

        try {
          // Open Agent Composer in enhance mode with this agent's context
          await window.agentManagerAPI.enhanceAgent(agentId);
        } catch (error) {
          console.error('Error opening composer:', error);
          alert('Could not open Agent Composer: ' + error.message);
        }
      }

      // ==================== LOADING ====================

      async function loadAgents() {
        try {
          agents = await window.agentManagerAPI.getAgents();
          renderAgents();
        } catch (error) {
          console.error('Error loading agents:', error);
        }
      }

      async function loadAgentStats() {
        try {
          const allStats = await window.agentManagerAPI.getAllStats();

          for (const agent of agents) {
            const statsEl = document.getElementById(`stats-${agent.id}`);
            if (!statsEl) continue;

            const stats = allStats[agent.id];
            if (!stats || stats.totalBids === 0) {
              statsEl.innerHTML = '<span style="font-style: italic;">No activity yet</span>';
              continue;
            }

            const winRate = Math.round(stats.winRate * 100);
            const successRate = Math.round(stats.successRate * 100);
            const avgConf = Math.round(stats.avgConfidence * 100);

            const avgTime = stats.avgExecutionTimeMs;
            const avgTimeStr = avgTime !== null ? formatDuration(avgTime) : null;

            statsEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <span style="color: ${winRate > 50 ? '#22c55e' : winRate > 20 ? '#f59e0b' : '#ef4444'};">
                                Win: ${winRate}%
                            </span>
                            <span style="color: #444;">|</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <span style="color: ${successRate > 80 ? '#22c55e' : successRate > 50 ? '#f59e0b' : '#ef4444'};">
                                Success: ${successRate}%
                            </span>
                            <span style="color: #444;">|</span>
                        </div>
                        <div>Avg Conf: ${avgConf}%</div>
                        ${avgTimeStr ? `<div style="color: #888;">Avg Run: ${avgTimeStr}</div>` : ''}
                        <div style="color: #555;">Bids: ${stats.totalBids}</div>
                        ${stats.lastActive ? `<div style="color: #444;">Last: ${formatTimeAgo(stats.lastActive)}</div>` : ''}
                    `;
          }
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      }

      function formatTimeAgo(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        return `${diffDays}d ago`;
      }

      function formatDuration(ms) {
        if (ms < 1000) return `${ms}ms`;
        if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
        const mins = Math.floor(ms / 60000);
        const secs = Math.round((ms % 60000) / 1000);
        return `${mins}m ${secs}s`;
      }

      async function loadGSXConnections() {
        try {
          gsxConnections = await window.agentManagerAPI.getGSXConnections();
          renderGSXConnections();
        } catch (error) {
          console.error('Error loading GSX connections:', error);
        }
      }

      // ==================== UTILITIES ====================

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ==================== EVENT LISTENERS ====================

      // Store search
      storeSearch.addEventListener('input', (e) => {
        renderStore(e.target.value);
      });

      addAgentBtn.addEventListener('click', () => showAgentModal());
      addGSXBtn.addEventListener('click', () => showGSXModal());

      // Create custom agent from store tab - switch to My Agents tab and open modal
      createCustomAgentBtn.addEventListener('click', () => {
        // Switch to My Agents tab
        tabs.forEach((t) => t.classList.remove('active'));
        tabContents.forEach((tc) => tc.classList.remove('active'));
        document.querySelector('[data-tab="local"]').classList.add('active');
        document.getElementById('tab-local').classList.add('active');

        // Open the agent modal
        showAgentModal();
      });

      agentModalClose.addEventListener('click', hideAgentModal);
      agentModalCancel.addEventListener('click', hideAgentModal);
      agentModalSave.addEventListener('click', saveAgent);

      gsxModalClose.addEventListener('click', hideGSXModal);
      gsxModalCancel.addEventListener('click', hideGSXModal);
      gsxModalSave.addEventListener('click', saveGSX);

      // History modal
      document.getElementById('historyModalClose').addEventListener('click', hideHistoryModal);
      document.getElementById('historyModalCancel').addEventListener('click', hideHistoryModal);

      // Test tab
      document.getElementById('runTestBtn').addEventListener('click', runTest);
      document.getElementById('cancelTestBtn').addEventListener('click', cancelTest);
      document.getElementById('testPhrase').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') runTest();
      });

      // Test mode toggle
      document.querySelectorAll('input[name="testMode"]').forEach((radio) => {
        radio.addEventListener('change', (e) => {
          document.getElementById('singleAgentSelect').style.display = e.target.value === 'single' ? 'block' : 'none';
          if (e.target.value === 'all') {
            // Populate agent select for future use
            populateAgentSelect();
          }
        });
      });

      // Close modals on overlay click
      agentModal.addEventListener('click', (e) => {
        if (e.target === agentModal) hideAgentModal();
      });
      gsxModal.addEventListener('click', (e) => {
        if (e.target === gsxModal) hideGSXModal();
      });
      document.getElementById('historyModal').addEventListener('click', (e) => {
        if (e.target.id === 'historyModal') hideHistoryModal();
      });

      // ==================== INITIALIZATION ====================

      async function init() {
        await loadBuiltinAgentStates();
        await loadAgents();
        await loadGSXConnections();
      }

      if (window.agentManagerAPI) {
        console.log('[AgentManager] API available, starting init...');
        init()
          .then(() => {
            console.log('[AgentManager] Init complete');
          })
          .catch((err) => {
            console.error('[AgentManager] Init failed:', err);
            // Still try to render store with defaults
            renderStore();
          });
      } else {
        console.error('[AgentManager] API not available');
        // Still render store with defaults
        renderStore();
      }

      console.log('[AgentManager] Script loaded');
    </script>
  </body>
</html>
